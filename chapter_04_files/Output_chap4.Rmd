---
title: "Output_chapter4"
author: "JC"
date: "2022-09-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("/Users/jmunozav/Desktop/Chapter_book/Codes/chapter_4_C2.R")
```

## Data generation
For this example we used as simulated database, that mimics an observational study which aim was to study the effect of two seizure drugs (DMF and TERI) in the number of relapses for Multiple sclerosis patients. 

We consider two scenarios, when the treatment effect is homogeneous across the population and when there is a heterogeneous effect, i.e,  the treatment effect depends on patient characteristics as age, sex, and relapse history, being a type of drug more effective on certain patients than in others. On the last scenario for each patient it was calculated a treatment effect score (**Iscore**) and then they were classified according to Iscore quantiles into five treatment effect selection groups (High DMF, Moderate DMF,Neutral, Moderate TERI,High TERI).
```{r}
#1. Generate full datasets according to treatment effect scenarios ----
data_noHTE <- generate_data(n = 10000, beta = c(-0.2, -0.2, -0.2, -0.2, -0.2), seed = 1234) # no treatment effect
data_hiHTE <- generate_data(n = 10000, beta = c(log(0.3), log(0.5), log(1), log(1.1), log(1.5)), seed = 1234) # strong treatment effect

```
The generate_data () generates full datasets according to the treatment effect scenarios. The **data_noHTE** dataset corresponds to the homogeneous scenario, i.e., where treatment effect is invariant across the population and and the **data_hiHTE** dataset is related to the heterogeneous scenario.

```{r, fig.align="center", fig.width=6, fig.height=6, fig.cap="Figure 1:DAG data generation process",echo=FALSE}
DAG_plot()
```

In this case the **T** treatment allocation and the **Y** response are associated with certain confounders variables. Particularly in this case we consider as confounders **age** the age of the patient, **prevDMTefficacy** the previous DM treatment efficacy, **prerelapse_num** the relapse number previous to the treatment and **premedicalcost** the previous treatment costs. 

Independ variables affect the treatment allocation **Xt**,i.e.,  **numSymptoms** the number of symptons and the response variable **Xy**,i.e., **year** the time of event since the starting of the treatment.

The following graph is an overview of the distribution of the confounder variables employed in the simulated datasets. 

```{r, fig.align="center", fig.width=6, fig.height=6, fig.cap="Figure 2:Distribution of confounders and outcome variable",echo=FALSE}

#We need to adjust titles of subgraphs are names are overlapped
datap <- copy(data_noHTE)
p1<-plot_den(datap=datap,var="age",varlab="Age (years)")  #Age density
p2<-plot_count(datap=datap[, gender:= as.factor(ifelse(female==1,"Female","Male"))],var="gender",varlab="Gender") # Gender proportion
p3<-plot_count(datap=datap[, efficacy := factor(ifelse(prevDMTefficacy=="Low_efficacy","Low",ifelse(prevDMTefficacy=="Medium_high_efficacy","Medium & high","None")),levels=c("None","Low","Medium & high"))],
               var="efficacy",varlab="Previous efficacy") # Previuos treatment proportion
p4<-plot_den(datap=datap,var="logprecost",varlab="Log previous cost")  #log cost density
p5<-plot_count(datap=datap,var="prerelapse_num",varlab="Previous relapse number") # Previous relapses proportion
p6<-Relapserate_plot()
ggpubr::ggarrange(p1,p2,p3,p4,p5,p6, ncol = 3, nrow = 2)# All plots together

```

## Treatment effect estimation

In Random clinical trial RTC, the treatment effect is directly estimated as patients are randomly allocated on each treatment branch. However in this case, the comparison of the response between both treatment branch (DMF and TERI) could be biased due to confounders. Having a look on the covariate balance plot we observe that people included in the DMF and the TERI branch are remarkable different in terms of the age and the previous treatment cost. 
```{r, fig.align="center", fig.width=6, fig.height=6, fig.cap="Figure 3: Balance confounder variables on treatment brances",echo=FALSE,warning=FALSE}
balance_plot(data = data_noHTE)
```

The **Y** mean comparison can be estimated by using different methods (Schafer&Kang,2008) but for ilustration, here we estimate the treatment effect by using only the matching, Inverse Propensity weighting (IPW) and the regression on counterfactuals methods.

Particularly for the first two methods we calculated two estimads the **ATE** average treatment effect and the **ATT** average treatment effect on treated, employing the matchit() and the weightit() functions from the R Matching package to balance the baseline covariates.  


## Missing generation process

I slightly modify the mechanism as you wanted a missing covariate that would be normal.. so I use the log of cost and on it i applied the different missing mechanisms MCAR, MAR, MNAR. The rest of variables followed a MCAR mechanism. 

- Age, Sex and outcome no variation
- MCAR: prevDMTefficacy, numSymptoms, prev_relapse number % 10%
- log previous cost: 
   - MCAR
   - MAR ( dependable on age, sex and prevDMTefficacy, making that patients on HighTERI are likely to not report treatment cost. )
   - MART: The probability to having unobserved cost measurements are higher on TERI group. Not sure about this
   - MNAR: patients with high treatment cost are more likely to not report the previous cost value. 


## Imputation of missing covariates

### Counterfactual method
Impute the contrafactual values Y_TERI and Y_DMF using as imputation model predictors Confounders+Xt+Xy

#### Estimand
- ATE
- ATT



### Imputation + Balance method

#### Balance method
1- Matching
2- IPW

#### Propensity score model:
1- Imputed value
2- Missing indicator + mean value (replacement)
3- Missing indicator + imputed value

#### Imputation model:
1- Only covariates (X): Confounders + Xt + Xy
2- X + Y
3- Interaction terms between T*X, T*Y and X*Y
4- Imputation on each treatment group

#### Estimand
1- ATE
2- ATT

@Prof Thomas the functions are horrible because we calculated a bunch of scenarios, at the end we will not use this graph if i understood you well, so it is not better to 
A. Just focus in one type of data let's say heterogneus 
B. Create one function that people can modify by themselfs, i mean for imputation with balance procedures (Matching or IPW), they have 4 parameters to set (Balance method, propensity model, imputation model and estimand), so we can just present the formula of one of this (1(IPW),3(MI+impute),3(full interaction),1(ATE))

In your book i think is better to add like a section where are describred the assumptions on each method..


