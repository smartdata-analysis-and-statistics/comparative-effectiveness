{
  "hash": "53c03aa46bc076738b0eaf918714528f",
  "result": {
    "markdown": "---\ntitle: \"Dealing with irregular and informative visits\"\nauthors:   \n  - name: Janie Coulombe\n    orcid: 0000-0001-5531-841X\n    affiliations:\n      - ref: umontreal\n  - name: Thomas Debray\n    orcid: 0000-0002-1790-2719\n    affiliations:\n      - ref: smartdas\naffiliations:\n  - id: smartdas\n    name: Smart Data Analysis and Statistics B.V.\n    city: Utrecht\n  - id: umontreal\n    name: Université de Montréal\n    city: Montréal (QC), Canada\nformat:\n  html:\n    toc: true\n    number-sections: true\nexecute:\n  cache: true\nbibliography: 'https://api.citedrive.com/bib/0d25b38b-db8f-43c4-b934-f4e2f3bd655a/references.bib?x=eyJpZCI6ICIwZDI1YjM4Yi1kYjhmLTQzYzQtYjkzNC1mNGUyZjNiZDY1NWEiLCAidXNlciI6ICIyNTA2IiwgInNpZ25hdHVyZSI6ICI0MGFkYjZhMzYyYWE5Y2U0MjQ2NWE2ZTQzNjlhMWY3NTk5MzhhNzUxZDNjYWIxNDlmYjM4NDgwOTYzMzY5YzFlIn0=/bibliography.bib'\n---\n\n\n## Introduction\n\nWe first load the relevant R scripts:\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-1_86cd60ddaad5c0cdb8844d7ffbe256c0'}\n\n```{.r .cell-code}\nsource(\"resources/chapter 12/sim.r\")\nsource(\"resources/chapter 12/fig_functions.r\")\nsource(\"resources/chapter 12/mlmi.r\")\n```\n:::\n\n\n## Example dataset\n\nBelow, we generate an example dataset that contains information on the treatment allocation `x` and three baseline covariates `age`, `sex` and `edss` (EDSS at treatment start). The discrete outcome `y` represents the Expanded Disability Status Scale (EDSS) score after `time` months of treatment exposure. Briefly, the EDSS is a semi-continuous measure that varies from 0 (no disability) to 10 (death).\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-2_fab736a69740dd7d3b3696f8e3eb1ca1'}\n\n```{.r .cell-code}\nset.seed(9843626)\n\ndataset  <- sim_data_EDSS(npatients = 500,\n                          ncenters = 10,\n                          follow_up = 12*5,\n                          sd_a_t = 0.5,  \n                          baseline_EDSS = 1.3295, \n                          sd_alpha_ij = 1.46, \n                          sd_beta1_j = 0.20,  \n                          mean_age = 42.41,\n                          sd_age = 10.53,\n                          min_age = 18,\n                          beta_age = 0.05, \n                          beta_t = 0.014, \n                          beta_t2 = 0,   \n                          delta_xt = 0,\n                          delta_xt2 = 0,\n                          p_female = 0.75, \n                          beta_female = -0.2 ,\n                          delta_xf = 0,        \n                          rho = 0.8,           \n                          corFUN = corAR1,      \n                          tx_alloc_FUN = treatment_alloc_confounding_v2)\n```\n:::\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-3_1a3feef4cd6fa5912faa682b8e11b446'}\n::: {.cell-output-display}\n![Longitudinal distribution of the EDSS score. The shaded area depicts the interquartile range.](chapter_12_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nWe remove the outcome `y` according to the informative visit process that depends on the received treatment, gender, and age.\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-4_28e7a7af6c89960255d9a84b48205286'}\n\n```{.r .cell-code}\ndataset_visit <- censor_visits_a5(dataset, seed = 12345) %>% \n  dplyr::select(-y) %>%\n  mutate(time_x = time*x)\n```\n:::\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-5_1408321b154dd18d9f4d095ab0e8d40b'}\n\n:::\n\n\nIn the censored data, a total of 17 out of 5000 patients have a visit at `time=60`.\n\n## Estimation of treatment effect\n\nWe will estimate the marginal treatment effect at time `time=60`.\n\n### Original data\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-6_5dcc42a4857a48f5b6d1af78d4a63c7b'}\n\n```{.r .cell-code}\norigdat60 <- dataset %>% filter(time == 60)\n\n# Predict probability of treatment allocation\nfitps <- glm(x ~ age + sex + edss, family = 'binomial', \n             data = origdat60)\n\n# Derive the propensity score\norigdat60 <- origdat60 %>% \n  mutate(ipt = ifelse(x == 1, 1/predict(fitps, type = 'response'),\n                      1/(1 - predict(fitps, type = 'response'))))\n\n# Estimate \nfit_ref_m <- tidy(lm(y ~ x, weight = ipt, data = origdat60), conf.int = TRUE) \n```\n:::\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-7_001cfb650434804d9a70a13075369f11'}\n\n:::\n\n\n### Doubly-weighted marginal treatment effect\nWe here implement inverse probability of response weights into the estimating equations to adjust for nonrandom missingness [@Coulombe_2022, @coulombe_weighted_2021].\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-8_33619161a792ac662f802714e57e9281'}\n\n```{.r .cell-code}\nobsdat60 <- dataset_visit %>% \n  mutate(visit = ifelse(is.na(y_obs),0,1)) %>% \n  filter(time == 60)\n\ngamma <- glm(visit ~ x + sex + age + edss, \n             family = 'binomial', data = obsdat60)$coef   \n\nobsdat60 <- obsdat60 %>% mutate(rho_i = 1/exp(gamma[\"(Intercept)\"] +\n                                                          gamma[\"x\"]*x +\n                                                          gamma[\"sex\"]*sex +\n                                                          gamma[\"age\"]*age))\n\n# Predict probability of treatment allocation\nfitps <- glm(x ~ age + sex + edss, family='binomial', data = obsdat60)\n\n# Derive the propensity score\nobsdat60 <- obsdat60 %>% \n  mutate(ipt = ifelse(x==1, 1/predict(fitps, type='response'),\n                      1/(1 - predict(fitps, type='response'))))\n\n\nfit_w <- tidy(lm(y_obs ~ x, weights = ipt*rho_i, data = obsdat60), \n              conf.int = TRUE)\n```\n:::\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-9_65942c137b6606c77f554f7e68d91d48'}\n\n:::\n\n\n### Multilevel multiple imputation\n\nWe adopt the imputation approach proposed by @debray_methods_2023. Briefly, we impute the entire vector of `y_obs` for all 61 potential visits and generate 10 imputed datasets. Note: `mlmi` currently does not support imputation of treatment-covariate interaction terms.\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-10_46d03d7a62c6e52189fa50f2ae44249a'}\n\n```{.r .cell-code}\nimp <- impute_y_mice_3l(dataset_visit, seed = 12345)\n```\n:::\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-11_aef151d83afa41b38e0aacc9a4c7b2ff'}\n\n:::\n\n\nWe can now estimate the treatment effect in each imputed dataset\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-12_0a077888831bbf130ae5542ec5a39452'}\n\n```{.r .cell-code}\n# Predict probability of treatment allocation\nfitps <- glm(x ~ age + sex + edss, family = 'binomial', data = dataset_visit)\n  \n# Derive the propensity score\ndataset_visit <- dataset_visit %>% \n  mutate(ipt = ifelse(x == 1, 1/predict(fitps, type = 'response'),\n                      1/(1 - predict(fitps, type = 'response'))))\n  \nQ <- U <- rep(NA, 10) # Error variances\n\nfor (i in seq(10)) {\n  dati <- cbind(dataset_visit[,c(\"x\",\"ipt\",\"time\")], y_imp = imp[,i]) %>% \n    filter(time == 60)\n  \n  # Estimate \n  fit <- tidy(lm(y_imp ~ x, weight = ipt, data = dati), conf.int = TRUE) \n  \n  Q[i] <- fit %>% filter(term == \"x\") %>% pull(estimate)\n  U[i] <- (fit %>% filter(term == \"x\") %>% pull(std.error))**2\n}\n\nfit_mlmi <- pool.scalar(Q = Q, U = U)\n```\n:::\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-13_6e149d0919983b164b59a46645d35894'}\n\n:::\n\n\n## Reproduce the results using all data to compute the marginal effect with IIV-weighted\n\n### Doubly -weighted marginal treatment effect total\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-14_60ec176cfda514e7d29d3162088b7fa8'}\n\n```{.r .cell-code}\nobsdatall <- dataset_visit %>% mutate(visit = ifelse(is.na(y_obs),0,1))  \ngamma <- glm(visit ~ x + sex + age + edss, family = 'binomial', data = obsdatall)$coef   \nobsdatall <- obsdatall %>% mutate(rho_i = 1/exp(gamma[\"(Intercept)\"] +\n                                                gamma[\"x\"]*x +\n                                                gamma[\"sex\"]*sex +\n                                                gamma[\"age\"]*age))\n# Predict probability of treatment allocation\nfitps <- glm(x ~ age + sex + edss, family='binomial', data = obsdatall)\n# Derive the propensity score\nobsdatall <- obsdatall %>% mutate(ipt = ifelse(x==1, 1/predict(fitps, type='response'),\n                                             1/(1-predict(fitps, type='response'))))\nfit_w <- tidy(lm(y_obs ~ x, weights = ipt*rho_i, data = obsdatall), conf.int = TRUE)\n```\n:::\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-15_3d2559f0938807df1ce4900dfc52802a'}\n\n:::\n\n\n## Results\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-16_01e786161a30b0fc09366d49f4ce38ff'}\n::: {.cell-output-display}\n![](chapter_12_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n## Version info {.unnumbered}\nThis chapter was rendered using the following version of R and its packages:\n\n\n::: {.cell hash='chapter_12_cache/html/unnamed-chunk-17_67b18473f6b328e1153625a4f937561f'}\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.2.3 (2023-03-15 ucrt)\nPlatform: x86_64-w64-mingw32/x64 (64-bit)\nRunning under: Windows 10 x64 (build 19045)\n\nMatrix products: default\n\nlocale:\n[1] LC_COLLATE=Dutch_Netherlands.utf8  LC_CTYPE=Dutch_Netherlands.utf8   \n[3] LC_MONETARY=Dutch_Netherlands.utf8 LC_NUMERIC=C                      \n[5] LC_TIME=Dutch_Netherlands.utf8    \n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] sparseMVN_0.2.2 truncnorm_1.0-9 MASS_7.3-60     nlme_3.1-162   \n[5] mice_3.16.0     ggplot2_3.4.4   broom_1.0.5     dplyr_1.1.2    \n\nloaded via a namespace (and not attached):\n [1] shape_1.4.6        tidyselect_1.2.0   xfun_0.39          purrr_1.0.1       \n [5] splines_4.2.3      lattice_0.21-8     colorspace_2.1-0   vctrs_0.6.3       \n [9] generics_0.1.3     htmltools_0.5.5    yaml_2.3.7         pan_1.9           \n[13] utf8_1.2.3         survival_3.5-5     rlang_1.1.1        jomo_2.7-6        \n[17] pillar_1.9.0       nloptr_2.0.3       withr_2.5.2        glue_1.6.2        \n[21] RColorBrewer_1.1-3 foreach_1.5.2      lifecycle_1.0.4    munsell_0.5.0     \n[25] gtable_0.3.4       htmlwidgets_1.6.2  codetools_0.2-19   evaluate_0.23     \n[29] labeling_0.4.3     knitr_1.45         fastmap_1.1.1      fansi_1.0.4       \n[33] Rcpp_1.0.10        scales_1.2.1       backports_1.4.1    jsonlite_1.8.7    \n[37] farver_2.1.1       lme4_1.1-35.1      digest_0.6.31      grid_4.2.3        \n[41] cli_3.6.1          tools_4.2.3        magrittr_2.0.3     glmnet_4.1-8      \n[45] tibble_3.2.1       tidyr_1.3.0        pkgconfig_2.0.3    ellipsis_0.3.2    \n[49] Matrix_1.5-4.1     minqa_1.2.6        rmarkdown_2.25     rstudioapi_0.15.0 \n[53] iterators_1.0.14   rpart_4.1.21       mitml_0.4-5        R6_2.5.1          \n[57] boot_1.3-28.1      nnet_7.3-19        compiler_4.2.3    \n```\n:::\n:::\n\n\n## References {.unnumbered}\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}