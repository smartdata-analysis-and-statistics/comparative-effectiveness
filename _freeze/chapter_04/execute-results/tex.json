{
  "hash": "fe9d88d4c80ee54ffbaf8f4c7fb79f6f",
  "result": {
    "markdown": "---\ntitle: \"Dealing with missing data\"\nauthor: \"Johanna Munoz\"\nformat:\n  html:\n    toc: true\n    number-sections: true\neditor: visual\nexecute:\n  cache: true\n---\n\n\n\n\n\nIn this example, we consider the estimation of comparative treatment effects in the absence of treatment-effect heterogeneity.\n\n## Setup\n\n### Prepare R environment\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-2_c36aa280c0229267504eecec457abc08'}\n\n```{.r .cell-code}\nlibrary(mice)\nlibrary(dplyr)\nlibrary(ggmice)\nlibrary(MatchThem)\n```\n:::\n\n\n\n### Generating an observational dataset\n\nWe can simulate an observational dataset of $N = 3000$ patients as follows:\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-3_c6d25ef9ef93b5f672bfd93e6a05fa09'}\n\n```{.r .cell-code}\ndata_noHTE <- generate_data(n = 3000, seed = 1234) \n```\n:::\n\n\n\nThis dataset does not (yet) contain any missing values;\n\nThe simulated dataset contains two treatment groups with differences in baseline characteristics. For example, the figure below shows that we have baseline imbalance in age.\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/fig-dist-confounders_8528dc5c2f2200b983b2736172cc4897'}\n::: {.cell-output-display}\n![Distribution of confounders and outcome variable](chapter_04_files/figure-pdf/fig-dist-confounders-1.pdf){#fig-dist-confounders}\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-5_9a9aeada2c8e8811bf67a32e07085041'}\n\n:::\n\n\n\n### Generating missing values\n\nMissing values can be generated using the function `getmissdata()`, which considers the following patterns of missingness for the previous number of relapses (`prerelapse_num`):\n\n1.  MAR: missingness depends on `age` and `sex`\n2.  MART: missingness depends on `age`, `sex` and the treatment variable `treatment`\n3.  MARTY: missingness depends on `age`, `sex`, `treatment` and the outcome variable `y`\n4.  MNAR: missingness depends on `age`, `sex` and `prerelapse_num`\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-6_83248d42ac0315f77f42f690fe4b01da'}\n\n```{.r .cell-code}\nmdata_noHTE <- getmissdata(data_noHTE, \"MART\")\n```\n:::\n\n\n\nAfter introducing missing values, we only have complete data for $N=$ 946 patients.\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-7_0560226284bcdd9eab83c418edfe3920'}\n::: {.cell-output-display}\n\\begin{table}\n\n\\caption{\\label{tab:unnamed-chunk-7}Baseline characteristics of the incomplete dataset.}\n\\centering\n\\begin{tabular}[t]{llll}\n\\toprule\nÂ  & DMF & TERI & Overall\\\\\n\\midrule\n & (N=2265) & (N=735) & (N=3000)\\\\\n\\addlinespace[0.3em]\n\\multicolumn{4}{l}{\\textbf{Age (years)}}\\\\\n\\hspace{1em}Mean (SD) & 44.4 (10.0) & 51.3 (8.72) & 46.2 (10.1)\\\\\n\\hspace{1em}Median [Min, Max] & 45.0 [18.0, 64.0] & 53.0 [23.0, 64.0] & 47.0 [18.0, 64.0]\\\\\n\\hspace{1em}Missing & 248 (10.9\\%) & 57 (7.8\\%) & 305 (10.2\\%)\\\\\n\\addlinespace[0.3em]\n\\multicolumn{4}{l}{\\textbf{Female Sex}}\\\\\n\\hspace{1em}Yes & 1740 (76.8\\%) & 526 (71.6\\%) & 2266 (75.5\\%)\\\\\n\\hspace{1em}No & 525 (23.2\\%) & 209 (28.4\\%) & 734 (24.5\\%)\\\\\n\\addlinespace[0.3em]\n\\multicolumn{4}{l}{\\textbf{Efficacy of previous DMT}}\\\\\n\\hspace{1em}None & 740 (32.7\\%) & 325 (44.2\\%) & 1065 (35.5\\%)\\\\\n\\hspace{1em}Low & 190 (8.4\\%) & 59 (8.0\\%) & 249 (8.3\\%)\\\\\n\\hspace{1em}Medium or High & 830 (36.6\\%) & 246 (33.5\\%) & 1076 (35.9\\%)\\\\\n\\hspace{1em}Missing & 505 (22.3\\%) & 105 (14.3\\%) & 610 (20.3\\%)\\\\\n\\addlinespace[0.3em]\n\\multicolumn{4}{l}{\\textbf{Prior medical costs}}\\\\\n\\hspace{1em}Mean (SD) & 9970 (10700) & 25500 (35400) & 13900 (21200)\\\\\n\\hspace{1em}Median [Min, Max] & 6530 [164, 102000] & 12500 [259, 337000] & 7450 [164, 337000]\\\\\n\\hspace{1em}Missing & 257 (11.3\\%) & 52 (7.1\\%) & 309 (10.3\\%)\\\\\n\\addlinespace[0.3em]\n\\multicolumn{4}{l}{\\textbf{Number of prior symptoms}}\\\\\n\\hspace{1em}0 & 157 (6.9\\%) & 58 (7.9\\%) & 215 (7.2\\%)\\\\\n\\hspace{1em}1 & 1169 (51.6\\%) & 411 (55.9\\%) & 1580 (52.7\\%)\\\\\n\\hspace{1em}>=2 & 435 (19.2\\%) & 159 (21.6\\%) & 594 (19.8\\%)\\\\\n\\hspace{1em}Missing & 504 (22.3\\%) & 107 (14.6\\%) & 611 (20.4\\%)\\\\\n\\addlinespace[0.3em]\n\\multicolumn{4}{l}{\\textbf{Number of prior relapses}}\\\\\n\\hspace{1em}Mean (SD) & 0.453 (0.671) & 0.408 (0.646) & 0.436 (0.662)\\\\\n\\hspace{1em}Median [Min, Max] & 0 [0, 4.00] & 0 [0, 3.00] & 0 [0, 4.00]\\\\\n\\hspace{1em}Missing & 1365 (60.3\\%) & 152 (20.7\\%) & 1517 (50.6\\%)\\\\\n\\bottomrule\n\\end{tabular}\n\\end{table}\n:::\n:::\n\n\n\n## Analysis of incomplete data\n\n### Complete Case Analysis\n\nBelow, we describe how to estimate the ATE using propensity score matching.\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-8_f1d8bc138b86dfcc9cfe2e2346a04790'}\n\n```{.r .cell-code}\nimpdata <- mdata_noHTE[complete.cases(mdata_noHTE), ]\n\n# Apply Matching\nmout <- matchit(DMF ~ age + female + prevDMTefficacy + premedicalcost + prerelapse_num, \n                data = impdata,\n                family = binomial,\n                method = \"full\",\n                caliper = 0.2,\n                estimand = \"ATE\",\n                replace = FALSE) \n\nmdata <- as.data.table(match.data(mout))\nmatch_mod <- glm(\"y ~ DMF + offset(log(years))\",\n                 family = poisson(link = \"log\"),\n                 data = mdata,\n                 weights = weights)\n\n# Estimate robust variance-covariance matrix\ntx_var <- vcovCL(match_mod, cluster = ~ subclass, sandwich = TRUE) \n```\n:::\n\n\n\nWe can extract the treatment effect estimate as follows:\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-9_a75baafbfb009aa4a4fb9b8fdeeebda2'}\n\n```{.r .cell-code}\n# Treatment effect estimate (log rate ratio)\ncoef(match_mod)[\"DMF\"]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       DMF \n-0.3524863 \n```\n:::\n\n```{.r .cell-code}\n# Standard error\nsqrt(tx_var[\"DMF\", \"DMF\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.1498211\n```\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-10_cd51bdb507a9113e160634dc41c86c39'}\n\n:::\n\n\n\n### Multiple Imputation (within method)\n\nIn this approach, we will generate $m=5$ imputed datasets and perform matching within each imputed dataset. We first need to specify how the variables `prevDMTefficacy`, `premedicalcost`, `numSymptoms`, `prerelapse_num` and `age` will be imputed:\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-11_a3a2a1b131b56111a11fc8ae8150d8d8'}\n\n```{.r .cell-code}\n# We add a covariate for log(years)\nimpdata <-  mdata_noHTE %>% mutate(logyears = log(years))\n\n# Specify the conditional imputation models\nform_y <- list(prevDMTefficacy ~ age + female + logyears + premedicalcost + numSymptoms + \n                 treatment + prerelapse_num + y,\n               premedicalcost ~ age + female + logyears + prevDMTefficacy + numSymptoms + \n                 treatment + prerelapse_num + y,\n               numSymptoms ~ age + female + premedicalcost + logyears + prevDMTefficacy + \n                 prerelapse_num + treatment + y,\n               prerelapse_num ~ age + female + premedicalcost + logyears + prevDMTefficacy + \n                 numSymptoms + treatment + y,\n               age ~ prerelapse_num + female + premedicalcost + logyears + prevDMTefficacy + \n                 numSymptoms + treatment + y)\nform_y <- name.formulas(form_y)\n\n# Adopt predictive mean matching for imputing the incomplete variables\nimp0 <- mice(impdata, form = form_y, maxit = 0)\nmethod <- imp0$method\nmethod[\"numSymptoms\"] <- \"pmm\"\nmethod[\"prevDMTefficacy\"] <- \"pmm\"\n\n# Generate 5 imputed datasets\nimp <- mice(impdata, form = form_y, method = method, m = 5, maxit = 100)\n```\n:::\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-12_97846c1479dbdc29610f098bbd7d9794'}\n\n:::\n\n\n\nWe can now estimate the ATE using propensity score analysis in each of the imputed datasets. We here adopt full matching without replacement.\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-13_a62fbd63dea02cadb64221e1bb5ac7da'}\n\n```{.r .cell-code}\n# Matching based on PS model\nmout <- matchthem(DMF ~ age + female + prevDMTefficacy + premedicalcost + prerelapse_num,\n                  datasets = imp,\n                  approach = \"within\",\n                  method = \"full\",\n                  caliper = 0.2,\n                  family = binomial,\n                  estimand = \"ATE\",\n                  distance = \"glm\",\n                  link = \"logit\",\n                  replace = FALSE) \n```\n:::\n\n\n\nThe results are then combined using Rubin's rules. We adopt robust standard errors to account for clustering of matched individuals.\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-14_ab765f54bb073e4c7945b486a47b111b'}\n\n```{.r .cell-code}\nmatch_mod <- summary(pool(with(mout, svyglm(y ~ DMF + offset(log(years)), \n                                            family = poisson(link = \"log\")),\n                               cluster = TRUE)), conf.int = TRUE)\n```\n:::\n\n\n\nWe can extract the treatment effect estimate and corresponding standard error as follows:\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-15_838ec78a190b8aa318be3985e6407371'}\n\n```{.r .cell-code}\n# Treatment effect estimate (log rate ratio)\n(match_mod %>% filter(term == \"DMF\"))$estimate\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.1172783\n```\n:::\n\n```{.r .cell-code}\n# Standard error\n(match_mod %>% filter(term == \"DMF\"))$std.error\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.1895277\n```\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-16_95544b76b619b411fc18a8c7f3a0bed6'}\n\n:::\n\n\n\n### Multiple Imputation (across method)\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-17_a0a2f6abf93f657f32c37fde64b5a530'}\n\n```{.r .cell-code}\n# Matching based on PS model\nmout <- matchthem(DMF ~ age + female + prevDMTefficacy + premedicalcost + prerelapse_num,\n                  datasets = imp,\n                  approach = \"across\",\n                  method = \"full\",\n                  caliper = 0.2,\n                  family = binomial,\n                  estimand = \"ATE\",\n                  distance = \"glm\",\n                  link = \"logit\",\n                  replace = FALSE) \n```\n:::\n\n\n\nThe results are then combined using Rubin's rules. We adopt robust standard errors to account for clustering of matched individuals.\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-18_795aacbbbd794e1f89dda8ab21433601'}\n\n```{.r .cell-code}\nmatch_mod <- summary(pool(with(mout, svyglm(y ~ DMF + offset(log(years)), \n                                            family = poisson(link = \"log\")),\n                               cluster = TRUE)), conf.int = TRUE)\n```\n:::\n\n\n\nWe can extract the treatment effect estimate and corresponding standard error as follows:\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-19_7e0229e1a49d3c660df032a434f076da'}\n\n```{.r .cell-code}\n# Treatment effect estimate (log rate ratio)\n(match_mod %>% filter(term == \"DMF\"))$estimate\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.2838299\n```\n:::\n\n```{.r .cell-code}\n# Standard error\n(match_mod %>% filter(term == \"DMF\"))$std.error\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.1221876\n```\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-20_3172010920f0632d2c722a9738fcf215'}\n\n:::\n\n\n\n## Convergence checking\n\nWe can inspect convergence for the imputed variable `prerelapse_num` using a trace plot:\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-21_e5caac0d0f2f6fc47455e34fb03ced20'}\n\n```{.r .cell-code}\nplot_trace(imp, vrb = \"prerelapse_num\")\n```\n\n::: {.cell-output-display}\n![](chapter_04_files/figure-pdf/unnamed-chunk-21-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Results\n\nAnalysis methods:\n\n-   **Full Data**: The treatment effect is estimated in the original data of $N=3000$ patients where no missing values are present. This estimate can be used as a benchmark to compare the missing data methods.\n-   **Complete Case Analysis**: The treatment effect is estimated using all data from $N=$ 946 patients that do not have any missing values.\n-   **Missing Indicator**: The treatment effect is estimated in the incomplete dataset of $N=3000$ patients. The propensity score model includes a missing indicator variable for each incomplete covariate.\n-   **MICE (within method)**: A treatment effect is estimated within each imputed dataset using propensity score analysis. Using Rubin's rule, the five treatment effects are combined into a single treatment effect.\n-   **MICE (ITE method)**: The missing covariates and potential outcomes are imputed simultaneously. Treatment effect estimates are derived by taking the average of the individualized treatment effect estimates Y\\|DMF - Y\\|TERI.\n\n\n\n::: {.cell hash='chapter_04_cache/pdf/unnamed-chunk-22_bfcb3b848610a675d44a43efb349f0ec'}\n::: {.cell-output-display}\n![](chapter_04_files/figure-pdf/unnamed-chunk-22-1.pdf)\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{\"knit_meta_id\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"]}},\"value\":[{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"booktabs\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"longtable\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"array\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"multirow\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"wrapfig\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"colortbl\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"pdflscape\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabu\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"threeparttable\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"threeparttablex\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"ulem\"]},{\"type\":\"character\",\"attributes\":{},\"value\":[\"normalem\"]},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"makecell\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"xcolor\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]}]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}