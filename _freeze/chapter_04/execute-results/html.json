{
  "hash": "268fe716ad1b5e3261581be4f16bdb9f",
  "result": {
    "markdown": "---\ntitle: \"Dealing with missing data\"\nauthor: \"Johanna Munoz\"\nformat:\n  html:\n    toc: true\n    number-sections: true\neditor: visual\nexecute:\n  cache: true\n---\n\n\n\n\nIn this example, we consider the estimation of comparative treatment effects in the absence of treatment-effect heterogeneity.\n\n## Setup\n\n### Prepare R environment\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-2_3f4285dc8e34ce5a8dee6c1cddcbb27b'}\n\n```{.r .cell-code}\nlibrary(mice)\nlibrary(dplyr)\nlibrary(ggmice)\nlibrary(MatchThem)\n```\n:::\n\n\n### Generating an observational dataset\n\nWe can simulate an observational dataset of $N = 3000$ patients as follows:\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-3_96f247dae9ed913b5a317c39ce355ec7'}\n\n```{.r .cell-code}\ndata_noHTE <- generate_data(n = 3000, seed = 1234) \n```\n:::\n\n\nThis dataset does not (yet) contain any missing values;\n\nThe simulated dataset contains two treatment groups with differences in baseline characteristics. For example, the figure below shows that we have baseline imbalance in age.\n\n\n::: {.cell hash='chapter_04_cache/html/fig-dist-confounders_02de7f531738c402b16d88e028648d78'}\n::: {.cell-output-display}\n![Distribution of the EDSS score at each time point](chapter_04_files/figure-html/fig-dist-confounders-1.png){#fig-dist-confounders width=672}\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-5_d707ef161892df403724fae9351ad247'}\n\n:::\n\n\n### Generating missing values\n\nMissing values can be generated using the function `getmissdata()`, which considers the following patterns of missingness for the previous number of relapses (`prerelapse_num`):\n\n1.  MAR: missingness depends on `age` and `sex`\n2.  MART: missingness depends on `age`, `sex` and the treatment variable `treatment`\n3.  MARTY: missingness depends on `age`, `sex`, `treatment` and the outcome variable `y`\n4.  MNAR: missingness depends on `age`, `sex` and `prerelapse_num`\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-6_ade44e69309579697033223dde29e217'}\n\n```{.r .cell-code}\nmdata_noHTE <- getmissdata(data_noHTE, \"MART\")\n```\n:::\n\n\nAfter introducing missing values, we only have complete data for $N=$ 946 patients.\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-7_81bdb1b94ad5e2a511fbe85d6db9631d'}\n::: {.cell-output-display}\n```{=html}\n<div class=\"Rtable1\"><table class=\"Rtable1\"><caption>Baseline characteristics of the incomplete dataset.</caption>\n\n<thead>\n<tr>\n<th class='rowlabel firstrow lastrow'></th>\n<th class='firstrow lastrow'><span class='stratlabel'>DMF<br><span class='stratn'>(N=2265)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>TERI<br><span class='stratn'>(N=735)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>Overall<br><span class='stratn'>(N=3000)</span></span></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class='rowlabel firstrow'>Age (years)</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>Mean (SD)</td>\n<td>44.4 (10.0)</td>\n<td>51.3 (8.72)</td>\n<td>46.2 (10.1)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Median [Min, Max]</td>\n<td>45.0 [18.0, 64.0]</td>\n<td>53.0 [23.0, 64.0]</td>\n<td>47.0 [18.0, 64.0]</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Missing</td>\n<td class='lastrow'>248 (10.9%)</td>\n<td class='lastrow'>57 (7.8%)</td>\n<td class='lastrow'>305 (10.2%)</td>\n</tr>\n<tr>\n<td class='rowlabel firstrow'>Female Sex</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>Yes</td>\n<td>1740 (76.8%)</td>\n<td>526 (71.6%)</td>\n<td>2266 (75.5%)</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>No</td>\n<td class='lastrow'>525 (23.2%)</td>\n<td class='lastrow'>209 (28.4%)</td>\n<td class='lastrow'>734 (24.5%)</td>\n</tr>\n<tr>\n<td class='rowlabel firstrow'>Efficacy of previous DMT</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>None</td>\n<td>740 (32.7%)</td>\n<td>325 (44.2%)</td>\n<td>1065 (35.5%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Low</td>\n<td>190 (8.4%)</td>\n<td>59 (8.0%)</td>\n<td>249 (8.3%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Medium or High</td>\n<td>830 (36.6%)</td>\n<td>246 (33.5%)</td>\n<td>1076 (35.9%)</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Missing</td>\n<td class='lastrow'>505 (22.3%)</td>\n<td class='lastrow'>105 (14.3%)</td>\n<td class='lastrow'>610 (20.3%)</td>\n</tr>\n<tr>\n<td class='rowlabel firstrow'>Prior medical costs</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>Mean (SD)</td>\n<td>9970 (10700)</td>\n<td>25500 (35400)</td>\n<td>13900 (21200)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Median [Min, Max]</td>\n<td>6530 [164, 102000]</td>\n<td>12500 [259, 337000]</td>\n<td>7450 [164, 337000]</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Missing</td>\n<td class='lastrow'>257 (11.3%)</td>\n<td class='lastrow'>52 (7.1%)</td>\n<td class='lastrow'>309 (10.3%)</td>\n</tr>\n<tr>\n<td class='rowlabel firstrow'>Number of prior symptoms</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>0</td>\n<td>157 (6.9%)</td>\n<td>58 (7.9%)</td>\n<td>215 (7.2%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>1</td>\n<td>1169 (51.6%)</td>\n<td>411 (55.9%)</td>\n<td>1580 (52.7%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>>=2</td>\n<td>435 (19.2%)</td>\n<td>159 (21.6%)</td>\n<td>594 (19.8%)</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Missing</td>\n<td class='lastrow'>504 (22.3%)</td>\n<td class='lastrow'>107 (14.6%)</td>\n<td class='lastrow'>611 (20.4%)</td>\n</tr>\n<tr>\n<td class='rowlabel firstrow'>Number of prior relapses</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>Mean (SD)</td>\n<td>0.453 (0.671)</td>\n<td>0.408 (0.646)</td>\n<td>0.436 (0.662)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Median [Min, Max]</td>\n<td>0 [0, 4.00]</td>\n<td>0 [0, 3.00]</td>\n<td>0 [0, 4.00]</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Missing</td>\n<td class='lastrow'>1365 (60.3%)</td>\n<td class='lastrow'>152 (20.7%)</td>\n<td class='lastrow'>1517 (50.6%)</td>\n</tr>\n</tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Analysis of incomplete data\n\n### Complete Case Analysis\n\nBelow, we describe how to estimate the ATE using propensity score matching.\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-8_0cadf119e4b3d8314f3ef5a875188378'}\n\n```{.r .cell-code}\nimpdata <- mdata_noHTE[complete.cases(mdata_noHTE), ]\n\n# Apply Matching\nmout <- matchit(DMF ~ age + female + prevDMTefficacy + premedicalcost + prerelapse_num, \n                data = impdata,\n                family = binomial,\n                method = \"full\",\n                caliper = 0.2,\n                estimand = \"ATE\",\n                replace = FALSE) \n\nmdata <- as.data.table(match.data(mout))\nmatch_mod <- glm(\"y ~ DMF + offset(log(years))\",\n                 family = poisson(link = \"log\"),\n                 data = mdata,\n                 weights = weights)\n\n# Estimate robust variance-covariance matrix\ntx_var <- vcovCL(match_mod, cluster = ~ subclass, sandwich = TRUE) \n```\n:::\n\n\nWe can extract the treatment effect estimate as follows:\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-9_21787c578e248713520357e4885cc3e1'}\n\n```{.r .cell-code}\n# Treatment effect estimate (log rate ratio)\ncoef(match_mod)[\"DMF\"]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       DMF \n-0.3524863 \n```\n:::\n\n```{.r .cell-code}\n# Standard error\nsqrt(tx_var[\"DMF\", \"DMF\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.1498211\n```\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-10_e78fb08d915892a04a82a8a1f2d4aa48'}\n\n:::\n\n\n### Multiple Imputation (within method)\n\nIn this approach, we will generate $m=5$ imputed datasets and perform matching within each imputed dataset. We first need to specify how the variables `prevDMTefficacy`, `premedicalcost`, `numSymptoms`, `prerelapse_num` and `age` will be imputed:\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-11_ce0ec1a3484b051e1ae76d0c6f7f3fd2'}\n\n```{.r .cell-code}\n# We add a covariate for log(years)\nimpdata <-  mdata_noHTE %>% mutate(logyears = log(years))\n\n# Specify the conditional imputation models\nform_y <- list(prevDMTefficacy ~ age + female + logyears + premedicalcost + numSymptoms + \n                 treatment + prerelapse_num + y,\n               premedicalcost ~ age + female + logyears + prevDMTefficacy + numSymptoms + \n                 treatment + prerelapse_num + y,\n               numSymptoms ~ age + female + premedicalcost + logyears + prevDMTefficacy + \n                 prerelapse_num + treatment + y,\n               prerelapse_num ~ age + female + premedicalcost + logyears + prevDMTefficacy + \n                 numSymptoms + treatment + y,\n               age ~ prerelapse_num + female + premedicalcost + logyears + prevDMTefficacy + \n                 numSymptoms + treatment + y)\nform_y <- name.formulas(form_y)\n\n# Adopt predictive mean matching for imputing the incomplete variables\nimp0 <- mice(impdata, form = form_y, maxit = 0)\nmethod <- imp0$method\nmethod[\"numSymptoms\"] <- \"pmm\"\nmethod[\"prevDMTefficacy\"] <- \"pmm\"\n\n# Generate 5 imputed datasets\nimp <- mice(impdata, form = form_y, method = method, m = 5, maxit = 100)\n```\n:::\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-12_befec2bc517db0bf3570568ab787bc79'}\n\n:::\n\n\nWe can now estimate the ATE using propensity score analysis in each of the imputed datasets. We here adopt full matching without replacement.\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-13_90c30e8e636a81517436ad7890bcc34b'}\n\n```{.r .cell-code}\n# Matching based on PS model\nmout <- matchthem(DMF ~ age + female + prevDMTefficacy + premedicalcost + prerelapse_num,\n                  datasets = imp,\n                  approach = \"within\",\n                  method = \"full\",\n                  caliper = 0.2,\n                  family = binomial,\n                  estimand = \"ATE\",\n                  distance = \"glm\",\n                  link = \"logit\",\n                  replace = FALSE) \n```\n:::\n\n\nThe results are then combined using Rubin's rules. We adopt robust standard errors to account for clustering of matched individuals.\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-14_82cdb2d3d18d0fe108c49b6044f423e4'}\n\n```{.r .cell-code}\nmatch_mod <- summary(pool(with(mout, svyglm(y ~ DMF + offset(log(years)), \n                                            family = poisson(link = \"log\")),\n                               cluster = TRUE)), conf.int = TRUE)\n```\n:::\n\n\nWe can extract the treatment effect estimate and corresponding standard error as follows:\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-15_fb8e1fc3de0e9382e05fddb6f143e774'}\n\n```{.r .cell-code}\n# Treatment effect estimate (log rate ratio)\n(match_mod %>% filter(term == \"DMF\"))$estimate\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.1172783\n```\n:::\n\n```{.r .cell-code}\n# Standard error\n(match_mod %>% filter(term == \"DMF\"))$std.error\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.1895277\n```\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-16_d00fdb61fc3434921d6a43596612dc13'}\n\n:::\n\n\n### Multiple Imputation (across method)\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-17_dff3962c3cd43d221a7b2f9852012423'}\n\n```{.r .cell-code}\n# Matching based on PS model\nmout <- matchthem(DMF ~ age + female + prevDMTefficacy + premedicalcost + prerelapse_num,\n                  datasets = imp,\n                  approach = \"across\",\n                  method = \"full\",\n                  caliper = 0.2,\n                  family = binomial,\n                  estimand = \"ATE\",\n                  distance = \"glm\",\n                  link = \"logit\",\n                  replace = FALSE) \n```\n:::\n\n\nThe results are then combined using Rubin's rules. We adopt robust standard errors to account for clustering of matched individuals.\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-18_d29ffa3fadd6f6ddc25f02a551a7e1a8'}\n\n```{.r .cell-code}\nmatch_mod <- summary(pool(with(mout, svyglm(y ~ DMF + offset(log(years)), \n                                            family = poisson(link = \"log\")),\n                               cluster = TRUE)), conf.int = TRUE)\n```\n:::\n\n\nWe can extract the treatment effect estimate and corresponding standard error as follows:\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-19_646e63a7d334d18fc1c0313c778b74c3'}\n\n```{.r .cell-code}\n# Treatment effect estimate (log rate ratio)\n(match_mod %>% filter(term == \"DMF\"))$estimate\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.2838299\n```\n:::\n\n```{.r .cell-code}\n# Standard error\n(match_mod %>% filter(term == \"DMF\"))$std.error\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.1221876\n```\n:::\n:::\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-20_38cd82b345171c109d24fa51ecd5f701'}\n\n:::\n\n\n## Convergence checking\n\nWe can inspect convergence for the imputed variable `prerelapse_num` using a trace plot:\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-21_6d1ebb104347ccd2452164adda7e1acf'}\n\n```{.r .cell-code}\nplot_trace(imp, vrb = \"prerelapse_num\")\n```\n\n::: {.cell-output-display}\n![](chapter_04_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## Results\n\nAnalysis methods:\n\n-   **Full Data**: The treatment effect is estimated in the original data of $N=3000$ patients where no missing values are present. This estimate can be used as a benchmark to compare the missing data methods.\n-   **Complete Case Analysis**: The treatment effect is estimated using all data from $N=$ 946 patients that do not have any missing values.\n-   **Missing Indicator**: The treatment effect is estimated in the incomplete dataset of $N=3000$ patients. The propensity score model includes a missing indicator variable for each incomplete covariate.\n-   **MICE (within method)**: A treatment effect is estimated within each imputed dataset using propensity score analysis. Using Rubin's rule, the five treatment effects are combined into a single treatment effect.\n-   **MICE (ITE method)**: The missing covariates and potential outcomes are imputed simultaneously. Treatment effect estimates are derived by taking the average of the individualized treatment effect estimates Y\\|DMF - Y\\|TERI.\n\n\n::: {.cell hash='chapter_04_cache/html/unnamed-chunk-22_f28658f018d3147c92e8d38d6a48da11'}\n::: {.cell-output-display}\n![](chapter_04_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/table1-1.0/table1_defaults.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}