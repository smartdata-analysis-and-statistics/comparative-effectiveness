{
  "hash": "5454d7b47389a100369c77ffe30c8d7c",
  "result": {
    "markdown": "---\ntitle: \"Prediction of individual treatment effect using data from multiple studies\"\nauthors:   \n  - name: Orestis Efthimiou\n    orcid: 0000-0002-0955-7572\n    affiliations:\n      - ref: ubern\naffiliations:\n  - id: smartdas\n    name: Smart Data Analysis and Statistics B.V.\n    city: Utrecht\n  - id: ubern\n    name: Institute of Social and Preventive Medicine (ISPM)\n    city: Bern, Switzerland\nformat:\n  html:\n    toc: true\n    number-sections: true\nexecute:\n  cache: true\nbibliography: 'https://api.citedrive.com/bib/0d25b38b-db8f-43c4-b934-f4e2f3bd655a/references.bib?x=eyJpZCI6ICIwZDI1YjM4Yi1kYjhmLTQzYzQtYjkzNC1mNGUyZjNiZDY1NWEiLCAidXNlciI6ICIyNTA2IiwgInNpZ25hdHVyZSI6ICI0MGFkYjZhMzYyYWE5Y2U0MjQ2NWE2ZTQzNjlhMWY3NTk5MzhhNzUxZDNjYWIxNDlmYjM4NDgwOTYzMzY5YzFlIn0=/bibliography.bib'\n---\n\n\nIn this chapter, we discuss statistical methods for developing models to predict patient-level treatment effects using data from multiple randomized and non-randomized studies. We will first present prediction models that assume a constant treatment effect and discuss how to address heterogeneity in baseline risk. Subsequently, we will discuss approaches that allow for treatment effect modification by adopting two different approaches in an IPD-MA context, namely the risk modelling and the effect modelling approach. For both approaches, we will first discuss how to combine IPD from RCTs comparing the same two treatments. We will then discuss how these methods can be extended to include randomized data from multiple treatments, real-world data, and published aggregate data. We will discuss statistical software to implement these approaches and provide example code as supporting information. Real examples will be used throughout to illustrate the main methods.\n\n## Setup\n\n\n::: {.cell hash='chapter_16_cache/html/unnamed-chunk-1_3c243efc9292b7df30addaa04fb321ee'}\n\n:::\n\n\nWe hereby provide code for estimating patient-level treatment effects for the case when we have patient-level data from multiple randomized trials.\n\n### Example of a continuous outcome\n\n#### Simulate data\nWe  start by simulating an artificial dataset using the R package **bipd**: \n\n\n::: {.cell hash='chapter_16_cache/html/ds_1bdc458905c46ccdf3a0d82c6a653e84'}\n\n```{.r .cell-code}\nlibrary(bipd)\nds <- generate_ipdma_example(type = \"continuous\")\n```\n:::\n\n\nLet us have a look at the dataset:\n\n::: {.cell hash='chapter_16_cache/html/ds2_5e1e23c5b1fa898e5ed89dd80ea1683d'}\n\n```{.r .cell-code}\nhead(ds)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  studyid treat         z1         z2  y\n1       1     0 -1.4080333  0.4976585 11\n2       1     1 -0.2808028  0.7054476 10\n3       1     1  0.1434411 -0.6242589  8\n4       1     0 -0.5011206  1.0614987 11\n5       1     1 -0.6102570  0.1756299  9\n6       1     0 -0.7205885  1.9777567 11\n```\n:::\n:::\n\n\nThe simulated dataset contains information on the following variables:\n\n- the treatment indicator `treat`, which takes the values 0 for control and 1 for active treatment\n- two prognostic variables `z1` and `z2`\n- the continuous outcome `y`\n- a trial indicator `studyid`\n\n\n::: {#tbl-summary-continuous_outcome-data .cell tbl-cap='The simulated dataset with a continuous outcome' hash='chapter_16_cache/html/tbl-summary-continuous_outcome-data_cf83afa9e1cc9a4d65e698b32ad2abd8'}\n::: {.cell-output-display}\n```{=html}\n<div class=\"Rtable1\"><table class=\"Rtable1\">\n<thead>\n<tr>\n<th class='rowlabel firstrow lastrow'></th>\n<th class='firstrow lastrow'><span class='stratlabel'>0<br><span class='stratn'>(N=300)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>1<br><span class='stratn'>(N=300)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>Overall<br><span class='stratn'>(N=600)</span></span></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class='rowlabel firstrow'>z1</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>Mean (SD)</td>\n<td>-0.0375 (0.952)</td>\n<td>0.0952 (0.986)</td>\n<td>0.0288 (0.971)</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Median [Min, Max]</td>\n<td class='lastrow'>-0.0861 [-2.88, 2.88]</td>\n<td class='lastrow'>0.0943 [-2.99, 3.25]</td>\n<td class='lastrow'>0.00957 [-2.99, 3.25]</td>\n</tr>\n<tr>\n<td class='rowlabel firstrow'>z2</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>Mean (SD)</td>\n<td>-0.0839 (1.01)</td>\n<td>-0.122 (1.07)</td>\n<td>-0.103 (1.04)</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Median [Min, Max]</td>\n<td class='lastrow'>-0.0329 [-2.96, 2.81]</td>\n<td class='lastrow'>-0.145 [-3.11, 2.66]</td>\n<td class='lastrow'>-0.0843 [-3.11, 2.81]</td>\n</tr>\n<tr>\n<td class='rowlabel firstrow'>studyid</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>1</td>\n<td>44 (14.7%)</td>\n<td>56 (18.7%)</td>\n<td>100 (16.7%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>2</td>\n<td>48 (16.0%)</td>\n<td>52 (17.3%)</td>\n<td>100 (16.7%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>3</td>\n<td>47 (15.7%)</td>\n<td>53 (17.7%)</td>\n<td>100 (16.7%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>4</td>\n<td>59 (19.7%)</td>\n<td>41 (13.7%)</td>\n<td>100 (16.7%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>5</td>\n<td>55 (18.3%)</td>\n<td>45 (15.0%)</td>\n<td>100 (16.7%)</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>6</td>\n<td class='lastrow'>47 (15.7%)</td>\n<td class='lastrow'>53 (17.7%)</td>\n<td class='lastrow'>100 (16.7%)</td>\n</tr>\n</tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n#### Perform analysis\nWe synthesize the evidence using a Bayesian random effects meta-analysis model. The model is given in Equation 16.7 of the book. First we need set up the data and create the model:\n\n::: {.cell hash='chapter_16_cache/html/MAcont1_200bd49993dfb87dbbef5e38db5e5b2c'}\n\n```{.r .cell-code}\nipd <- with(ds, ipdma.model.onestage(y = y, study = studyid, treat = treat,\n                                     X = cbind(z1, z2), \n                                     response = \"normal\", \n                                     shrinkage = \"none\"), \n                                     type=\"random\")\n```\n:::\n\n\nThe JAGS model can be accessed as follows:\n\n\n::: {.cell hash='chapter_16_cache/html/MAcont2_2d035deb92effc2a2c45c21fd6436947'}\n\n```{.r .cell-code}\nipd$model.JAGS\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nfunction () \n{\n    for (i in 1:Np) {\n        y[i] ~ dnorm(mu[i], sigma)\n        mu[i] <- alpha[studyid[i]] + inprod(beta[], X[i, ]) + \n            (1 - equals(treat[i], 1)) * inprod(gamma[], X[i, \n                ]) + d[studyid[i], treat[i]]\n    }\n    sigma ~ dgamma(0.001, 0.001)\n    for (j in 1:Nstudies) {\n        d[j, 1] <- 0\n        d[j, 2] ~ dnorm(delta[2], tau)\n    }\n    sd ~ dnorm(0, 1)\n    T(0, )\n    tau <- pow(sd, -2)\n    delta[1] <- 0\n    delta[2] ~ dnorm(0, 0.001)\n    for (j in 1:Nstudies) {\n        alpha[j] ~ dnorm(0, 0.001)\n    }\n    for (k in 1:Ncovariate) {\n        beta[k] ~ dnorm(0, 0.001)\n    }\n    for (k in 1:Ncovariate) {\n        gamma[k] ~ dnorm(0, 0.001)\n    }\n}\n<environment: 0x0000022fbe8d6760>\n```\n:::\n:::\n\nWe can fit the treatment effect model as follows:\n\n\n::: {.cell hash='chapter_16_cache/html/MAcont3_fca9fd1eadfa82658538018f55ed1ec1'}\n\n```{.r .cell-code}\nsamples <- ipd.run(ipd, n.chains = 2, n.iter = 20,\n                   pars.save = c(\"alpha\", \"beta\", \"delta\", \"sd\", \"gamma\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCompiling model graph\n   Resolving undeclared variables\n   Allocating nodes\nGraph information:\n   Observed stochastic nodes: 600\n   Unobserved stochastic nodes: 19\n   Total graph size: 6034\n\nInitializing model\n```\n:::\n:::\n\n\nHere are the estimated model parameters:\n\n\n::: {.cell hash='chapter_16_cache/html/MAcont4_f798eaad52f863d52ea174faf64c3f18'}\n\n```{.r .cell-code}\nsummary(samples)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nIterations = 2001:2020\nThinning interval = 1 \nNumber of chains = 2 \nSample size per chain = 20 \n\n1. Empirical mean and standard deviation for each variable,\n   plus standard error of the mean:\n\n            Mean      SD Naive SE Time-series SE\nalpha[1] 10.9224 0.04098 0.006479       0.009113\nalpha[2]  8.0255 0.04179 0.006607       0.006480\nalpha[3] 10.5387 0.05196 0.008216       0.011734\nalpha[4]  9.6712 0.03866 0.006113       0.011441\nalpha[5] 12.8963 0.04898 0.007744       0.009898\nalpha[6] 15.7597 0.06275 0.009921       0.015179\nbeta[1]   0.2009 0.01911 0.003022       0.004567\nbeta[2]   0.3261 0.02122 0.003356       0.005746\ndelta[1]  0.0000 0.00000 0.000000       0.000000\ndelta[2] -2.7797 0.88557 0.140020       0.117590\ngamma[1] -0.5375 0.02670 0.004221       0.009076\ngamma[2]  0.6140 0.02409 0.003809       0.004835\nsd        1.7917 0.38948 0.061582       0.081172\n\n2. Quantiles for each variable:\n\n            2.5%     25%     50%     75%   97.5%\nalpha[1] 10.8510 10.8987 10.9274 10.9525 10.9942\nalpha[2]  7.9603  7.9938  8.0195  8.0531  8.1029\nalpha[3] 10.4438 10.5105 10.5449 10.5766 10.6315\nalpha[4]  9.6069  9.6431  9.6675  9.6957  9.7395\nalpha[5] 12.8111 12.8646 12.8933 12.9260 13.0080\nalpha[6] 15.6232 15.7180 15.7610 15.8010 15.8648\nbeta[1]   0.1632  0.1856  0.2051  0.2136  0.2336\nbeta[2]   0.2900  0.3083  0.3284  0.3421  0.3572\ndelta[1]  0.0000  0.0000  0.0000  0.0000  0.0000\ndelta[2] -3.9673 -3.3691 -2.9707 -2.2861 -1.0929\ngamma[1] -0.5778 -0.5567 -0.5395 -0.5165 -0.4902\ngamma[2]  0.5652  0.5958  0.6204  0.6287  0.6471\nsd        1.1539  1.5357  1.7541  2.0721  2.6058\n```\n:::\n:::\n\n\nWe can now predict treatment effects for a new patient with covariate values `z1=1` and `z2=0.5`.\n\n\n::: {.cell hash='chapter_16_cache/html/MAcont5_cd2b01d9404ee2682dab9ed0f372a1d0'}\n\n```{.r .cell-code}\nround(treatment.effect(ipd, samples, newpatient= c(z1 = 1, z2 = 0.5)), 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n0.025   0.5 0.975 \n-4.36 -2.88 -1.63 \n```\n:::\n:::\n\n\nWe can also predict treatment benefit for all patients in the sample, and look at the distribution of predicted benefit.\n\n\n::: {.cell hash='chapter_16_cache/html/fig-predben_continuous_outcome_3271c9b30c0ce72df10422a3c4d06730'}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(ggplot2)\n\nds <- ds %>% mutate(benefit = NA)\n\nfor (i in seq(nrow(ds))) {\n  newpat <- as.matrix(ds[i, c(\"z1\", \"z2\")])\n  ds$benefit[i] <- treatment.effect(ipd, samples, newpatient = newpat)[\"0.5\"]\n}\n\nggplot(ds, aes(x = benefit)) + geom_histogram() + facet_wrap(~studyid) + \n  xlab(\"Predicted treatment benefit\")\n```\n\n::: {.cell-output-display}\n![Distribution of predicted treatment benefit in each trial](chapter_16_files/figure-html/fig-predben_continuous_outcome-1.png){#fig-predben_continuous_outcome width=672}\n:::\n:::\n\n\nLet us repeat the analysis, but this time while penalizing the treatment-covariate coefficients using a Bayesian LASSO prior. \n\n\n::: {.cell hash='chapter_16_cache/html/MAcont6_af518e6f3bc3c2f0630cd31dd468797c'}\n\n```{.r .cell-code}\nipd <- with(ds, ipdma.model.onestage(y = y, study = studyid, treat = treat,\n                                     X = cbind(z1, z2), response = \"normal\", \n                                     shrinkage = \"laplace\"), type=\"random\")\n```\n:::\n\nThe model is as follows:\n\n::: {.cell hash='chapter_16_cache/html/MAcont7_fd357abfb3df56d49a2724c4414e1cc2'}\n\n```{.r .cell-code}\nipd$model.JAGS\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nfunction () \n{\n    for (i in 1:Np) {\n        y[i] ~ dnorm(mu[i], sigma)\n        mu[i] <- alpha[studyid[i]] + inprod(beta[], X[i, ]) + \n            (1 - equals(treat[i], 1)) * inprod(gamma[], X[i, \n                ]) + d[studyid[i], treat[i]]\n    }\n    sigma ~ dgamma(0.001, 0.001)\n    for (j in 1:Nstudies) {\n        d[j, 1] <- 0\n        d[j, 2] ~ dnorm(delta[2], tau)\n    }\n    sd ~ dnorm(0, 1)\n    T(0, )\n    tau <- pow(sd, -2)\n    delta[1] <- 0\n    delta[2] ~ dnorm(0, 0.001)\n    for (j in 1:Nstudies) {\n        alpha[j] ~ dnorm(0, 0.001)\n    }\n    for (k in 1:Ncovariate) {\n        beta[k] ~ dnorm(0, 0.001)\n    }\n    tt <- lambda * sigma\n    lambda <- pow(lambda.inv, -1)\n    lambda.inv ~ dunif(0, 5)\n    for (k in 1:Ncovariate) {\n        gamma[k] ~ ddexp(0, tt)\n    }\n}\n<environment: 0x0000022fbfd4fa18>\n```\n:::\n:::\n\nTo do the analysis we run:\n\n\n::: {.cell hash='chapter_16_cache/html/MAcont8_7620f7cd595a5fa7084c9524890a79ad'}\n\n```{.r .cell-code}\nsamples <- ipd.run(ipd, n.chains=2, n.iter=20, \n                   pars.save = c(\"alpha\", \"beta\", \"delta\", \"sd\", \"gamma\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCompiling model graph\n   Resolving undeclared variables\n   Allocating nodes\nGraph information:\n   Observed stochastic nodes: 600\n   Unobserved stochastic nodes: 20\n   Total graph size: 6039\n\nInitializing model\n```\n:::\n\n```{.r .cell-code}\nround(treatment.effect(ipd, samples, newpatient = c(1,0.5)), 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n0.025   0.5 0.975 \n-4.76 -3.11 -1.59 \n```\n:::\n:::\n\n\n### Example of a binary outcome\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/table1-1.0/table1_defaults.css\" rel=\"stylesheet\" />\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}