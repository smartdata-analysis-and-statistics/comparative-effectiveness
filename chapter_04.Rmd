---
title: "Dealing with missing data"
author: "Johanna Munoz"
date:  "This report was generated on `r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(kableExtra)
library(table1)

source("Chapter 04 - Missing Data Imputation/chapter_4.r")
```
# Prepare R environment

```{r}
library(mice)
library(ggmice)
```

# Absence of HTE

## Generating an observational dataset
We can simulate an observational dataset of $N = 3000$ patients as follows:
```{r}
data_noHTE <- generate_data(n = 3000, seed = 1234) 
```

This dataset does not (yet) contain any missing values;

The simulated dataset contains two treatment groups with differences in baseline characteristics. For example, the figure below shows that we have baseline imbalance in age.

```{r, fig.align="center", fig.width=6, fig.height=6, fig.cap="Figure 1:Distribution of confounders and outcome variable", echo = F}
plot_den(datap = data_noHTE,var="age",varlab="Age (years)")  #Age density
```

```{r, echo = F}
# Estimation of treatment effects in the complete data
true_noHTE_ATE <- getest(data = data_noHTE, estimandv = "ATE", Tform = 1, CC = TRUE)
true_noHTE_ATT <- getest(data = data_noHTE, estimandv = "ATT", Tform = 1, CC = TRUE)

ref_noHTE <- data.frame(rbind(true_noHTE_ATE,true_noHTE_ATT))
```

## Generating missing values
Missing values can be generated using the function `getmissdata()`, which considers the following patterns of missingness:

- Variables collected at patient registration are always complete (`age`, `female`)
- Prior medical costs (`premedicalcost`) are missing completely at random (MCAR).
- prevDMTefficacy, numSymptoms are missing at random (MAR) according to age (`age`) and gender (`female`). 

Furthermore, we considered four missingness scenarios for the availability of previous number of relapses (`prerelapse_num`):

1. MAR: missingness depends on `age` and `sex`
2. MART:  missingness depends on `age`, `sex` and the treatment variable `treatment`
3. MARTY: missingness depends on `age`, `sex`, `treatment` and the outcome variable `y`
4. MNAR:  missingness depends on `age`, `sex` and `prerelapse_num` 

```{r}
mdata_noHTE <- getmissdata(data_noHTE, "MART")
```

```{r echo = F}
dat <- formatMSdata(mdata_noHTE)

table1(~ age + female + prevDMTefficacy + premedicalcost + numSymptoms + prerelapse_num | treatment, data = dat, caption = "Baseline characteristics of the incomplete dataset.")
```

## Multiple Imputation

We first need to specify how each variable will be imputed
```{r}
# Specify the conditional imputation models
form_y <- list(prevDMTefficacy ~ age+female + years+premedicalcost+numSymptoms+treatment+prerelapse_num+y,
               premedicalcost~age+female + years+prevDMTefficacy+numSymptoms+treatment+prerelapse_num+y,
               numSymptoms ~age+female + premedicalcost+years+prevDMTefficacy+prerelapse_num+treatment+y,
               prerelapse_num ~age+female + premedicalcost+years+prevDMTefficacy+numSymptoms+treatment+y)
form_y <- name.formulas(form_y)

imp0 <- mice(mdata_noHTE, form = form_y, m=1, maxit = 0)
method <- imp0$method
method["numSymptoms"] <- "pmm"
method["prevDMTefficacy"] <- "pmm"
```

```{r eval = F}
# Generate 5 imputed datasets
imp <- mice(mdata_noHTE, form = form_y, method = method, m = 5, maxit = 50)
```

We can inspect convergence for the imputed variable `prerelapse_num` using a trace plot:
```{r echo = F}
load("Chapter 04 - Missing Data Imputation/imp_noHTE.rda")
```
```{r}
plot_trace(imp, vrb = "prerelapse_num")
```
