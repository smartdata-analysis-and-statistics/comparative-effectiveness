--- 
title: Effect Modification Analysis within the Propensity score Framework
author: Mohammad Ehsanul Karim^[School of Population and Public Health, The University of British Columbia; ehsan.karim@ubc.ca; https://ehsank.com/]
date: 'Last update: `r Sys.Date()`'
output:
  html_document:
    number_sections: true
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
      smooth_scroll: true
always_allow_html: yes
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = TRUE)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

require(table1)
require(cobalt)
require(WeightIt)
require(optmatch)
library(lmtest)
library(sandwich)
require(jtools)
require(huxtabl)
require(interactions)
require(MatchIt)
require(broom)
require(survey)
require(Publish)
require(readstata13)
require(cowplot)
require(knitr)
require(kableExtra)
require(dplyr)
require(xtable)
See.code <- FALSE
cache.ON <- TRUE
```

# Simulation

```{r, include=FALSE}
# devtools::install_github('osofr/simcausal', build_vignettes = FALSE)
```

```{r}
require(simcausal)
D <- DAG.empty()
D <- D + 
  node("age", distr = "rnorm", 
       mean = 2, sd = 4) + 
  node("gender", distr = "rbern", 
       prob = plogis(4)) +
  node("education", distr = "rbern", 
       prob = plogis(3 + 5* age)) +
  node("diet", distr = "rbern", 
       prob = plogis(1 -3 * education)) +
  node("income", distr = "rbern", 
       prob = plogis(2 - 5 * education - 4 * age)) +
  node("smoking", distr = "rbern", 
       prob = plogis(1 + 1.2 * gender + 2 * age)) +
  node("hypertension", distr = "rbern", 
       prob = plogis(1 + log(3) * diet + 
                       log(1.3) * age + 
                       log(3.5) * smoking + 
                       log(0.5) * gender))
Dset <- set.DAG(D)
plotDAG(Dset)
```


```{r}
Obs.Data <- sim(DAG = Dset, n = 50000, rndseed = 123)
```


# Effect measure assessment via adding interaction term



```{r, echo=FALSE}
Obs.Data.copy <- Obs.Data[order(Obs.Data$age,decreasing = TRUE),]
idxx <- c("34901","9979","22220","149","10060")
Obs.Data.copy2 <- Obs.Data.copy[Obs.Data.copy$ID %in% idxx,]
Obs.Data.copy2$ID <- NULL
kable(Obs.Data.copy2, row.names=FALSE, 
      caption="Sample data from the hypothetical example of association between hypertension and  smoking, where other variables such as income, age [centered], gender, education and diet also plays a role in the data generation process.\\label{tab:sampledata}", 
      format="latex", booktabs=TRUE, digits=2) %>% 
  kable_paper(full_width = FALSE) %>%
  kable_styling(latex_options = "hold_position")
```

```{r}
Obs.Data$smoking <- as.character(Obs.Data$smoking)
Obs.Data$income <- as.factor(Obs.Data$income)
Obs.Data$income <- relevel(Obs.Data$income, ref = "1")
fit.w.em <- glm(hypertension ~ smoking * income + age + gender, 
            family=binomial(link = "logit"), data=Obs.Data)
require(jtools)
results.model <- summ(fit.w.em, model.info = FALSE, 
                      model.fit = FALSE,
                      exp = TRUE)
```

```{r, echo=FALSE}
kable(results.model$coeftable, caption = 'Assessment of effect modification by income. The output shown from the logistic regression model in a odds ratio scale, where hypertnsion is the outcome, smoking is the exposure, age, gender are confounders, and main effect and interaction term of income and exposure are added. Here the interaction term is significant.\\label{tab:effmod0}', format="latex", booktabs=TRUE, digits=2)#%>% 
  #kable_styling(latex_options="scale_down")
```


```{r, results='asis', echo=FALSE, include=FALSE}
kable(publish(fit.w.em, print = FALSE)$regressionTable[5:6,], 
      caption="", 
      format="latex", booktabs=TRUE, digits=0) #%>% 
  #kable_styling(latex_options="scale_down")
```

## Presentation of effect measures {-}

```{r}
require(interactionR)
em.object = interactionR(fit.w.em, 
                            exposure_names = c("income0", "smoking1"), 
                            ci.type = "mover", ci.level = 0.95, 
                            em=TRUE, recode = FALSE)
```

```{r, results='asis', echo=FALSE}
kable(em.object$dframe[5:7,], row.names = FALSE,
      caption="Summary report from an effect modification analysis by income when investigating association between one exposure variable (smoking) and outcome hypertension. Adjusted odds ratios are reported for income levels (`high' = 0, and `low' = 1).\\label{tab:effmod}", 
      format="latex", booktabs=TRUE, digits=2) #%>% 
  #kable_styling(latex_options="scale_down")
xxem <- em.object$dframe$Estimates[5:7]
```

# Effect measure assessment via stratified approach

```{r}
fit.income1 <- glm(hypertension ~ smoking + age + gender, 
            family = binomial(link = "logit"), 
            data = subset(Obs.Data, income == 1))
fit.income0 <- glm(hypertension ~ smoking + age + gender, 
            family=binomial(link = "logit"), 
            data= subset(Obs.Data, income == 0))
```


```{r, results='asis', echo=FALSE}
fit.exp.adj.res1 <- summ(fit.income1,  
     model.info = FALSE, 
     model.fit = FALSE, 
     exp = TRUE,
     confint = TRUE)
fit.exp.adj.res0 <- summ(fit.income0, 
     model.info = FALSE, 
     model.fit = FALSE, 
     exp = TRUE,
     confint = TRUE)
kable(cbind(`Value of income` = c(1,0),
            rbind(fit.exp.adj.res1$coeftable[2,],
                  fit.exp.adj.res0$coeftable[2,])),
      booktabs = TRUE, digits = 2,
      caption="\\label{tab2sub1}Summary report from an effect modification analysis by income via stratified approach when investigating association between one exposure variable (smoking) and outcome hypertension. Adjusted odds ratios are reported for income levels (`low' = 1, and `high' = 0).")
```

```{r, results='asis'}
fit.all.int <- glm(hypertension ~ income * (smoking + age + gender), 
            family=binomial(link = "logit"), data=Obs.Data)
```


```{r, results='asis', echo=FALSE}
kable(publish(fit.all.int, print = FALSE)$regressionTable[1:2,], 
      caption="\\label{tab2suball}Summary report from an effect modification analysis by income, when product terms between income (the modifier) and all covariates are added (on top of product term between income and smoking).", 
      format="latex", booktabs=TRUE, digits=0)
```


# Interaction


```{r}
fit.w.int <- glm(hypertension ~ smoking * income + age + gender + education, 
            family=binomial(link = "logit"), data=Obs.Data)
results.int.model <- summ(fit.w.int, model.info = FALSE, model.fit = FALSE, exp = TRUE)
```

```{r, results='asis', echo=FALSE}
knitr::kable(results.int.model$coeftable, caption = 'Assessment of interaction between smoking and income. The output shown from the logistic regression model in an odds ratio scale, where hypertnsion is the outcome, smoking and income are exposure variables, age, gender, and education are confounders, and an interaction term of smoking and income is added. The interaction term is, however, not significant.\\label{tab:effmod0i}', format="latex", booktabs=TRUE, digits=2)#%>% 
  #kable_styling(latex_options="scale_down")
```



## Presentation of effect measures  {-}

```{r}
int.object = interactionR(fit.w.int, 
                            exposure_names = c("smoking1", "income0"), 
                            ci.type = "mover", ci.level = 0.95, 
                            em=FALSE, recode = FALSE)
```

```{r, results='asis', echo=FALSE}
kable(int.object$dframe[,1:4], 
      caption="Summary report from an interaction analysis when investigating association between two exposure variables (smoking and income) and hypertension. Here CI.ll and CI.ul are lower and upper limits of 95 percent confidence intervals, $OR_{A = 1, M = 1}$ = OR11, $OR_{A = 1}$ = OR10, $OR_{M = 1}$ = OR01 and reference = OR00.\\label{tab:effint}", 
      format="latex", booktabs=TRUE, digits=2) #%>% 
  #kable_styling(latex_options="scale_down")
xxe <- int.object$dframe$Estimates
```

```{r}
# test run with additive model
Obs.Data$smoking <- as.numeric(as.character(Obs.Data$smoking))
Obs.Data$income <- as.numeric(as.character(Obs.Data$income))
fit.w.int.add <- glm(hypertension ~ smoking * income + age + gender + education, 
            family=gaussian(link = "identity"), data=Obs.Data)
sim_slopes(fit.w.int.add, pred = smoking, modx = income,exp = TRUE,robust = TRUE,
           confint = TRUE, data = Obs.Dat)
```

# Step-by-Step Guideline for Practitioners regarding Implementation


## Propensity score matching approaches

### Stratified approach with exact matching within subgroups  {-}

```{r}
# For income = 0
require(MatchIt)
set.seed(123)
Obs.Data <- sim(DAG = Dset, n = 5000, rndseed = 123)
match.income.0 <- matchit(smoking ~ age + gender, 
                            data = subset(Obs.Data, income == 0),
                      method = "full", distance = "glm", link = "logit")
data.income.0 <- match.data(match.income.0)
```


```{r, echo=FALSE}
data.income.0.copy <- data.income.0
idxx <- c("4932","252","1646","2693","657")
data.income.0.copy2 <- data.income.0.copy[data.income.0.copy$ID %in% idxx,]
data.income.0.copy2 <- data.income.0.copy2[order(data.income.0.copy2$age,decreasing = TRUE),]
data.income.0.copy2$ID <- NULL
kable(data.income.0.copy2, row.names=FALSE,
      booktabs = TRUE, digits = 2,
      caption="\\label{data.head}Sample subgrouped data from the high-income group based on the hypothetical example of an association between hypertension and smoking. Here age [centered], gender, education, and diet are covariates.") %>%
  kable_paper(full_width = FALSE) %>%
  kable_styling(latex_options = "hold_position")
```

```{r}
# For income = 1
match.income.1 <- matchit(smoking ~ age + gender, 
                          data = subset(Obs.Data, income == 1),
                       method = "full", distance = "glm", link = "logit")
data.income.1 <- match.data(match.income.1)
```

```{r}
# Treatment effect estimation
fit.income.0 <- glm(hypertension ~ smoking + age + gender, 
                   data = data.income.0, weights = weights,
                   family = binomial("logit"))
fit.income.1 <- glm(hypertension ~ smoking + age + gender, 
                   data = data.income.1, weights = weights,
                   family = binomial("logit"))
# Robust variance calculation
require(jtools)
fit.nexp.adj.res1 <- summ(fit.income.1,  
                          robust = TRUE,
                          cluster = "subclass",
                          model.info = FALSE, 
                          model.fit = FALSE, 
                          confint = TRUE)
fit.nexp.adj.res0 <- summ(fit.income.0, 
                          robust = TRUE,
                          cluster = "subclass",
                          model.info = FALSE, 
                          model.fit = FALSE, 
                          confint = TRUE)
```


```{r, echo=See.code, results='asis'}
kable(cbind(`Value of income` = c(0,1),
            rbind(fit.nexp.adj.res0$coeftable[2,],
                  fit.nexp.adj.res1$coeftable[2,])),
      booktabs = TRUE, digits = 2,
      caption="\\label{stratified.approach}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the stratified approach.") %>%
  kable_styling(latex_options = "hold_position")
```


### Joint approach without exact matching within subgroups  {-}

```{r}
ps.formula <- as.formula("smoking ~ age + gender + income")
match.obj.j <- matchit(ps.formula, data = Obs.Data,
                      method = "full", 
                      distance = "glm",
                      link = "logit")
match.data.j <- match.data(match.obj.j)
```

```{r}
fit.joint.no.exact <- glm(hypertension ~ smoking*income + age + gender, 
              data = match.data.j, weights = weights,
              family = binomial("logit"))
require(interactions)
nem.nexp.adj.res <- sim_slopes(fit.joint.no.exact, 
                               pred = smoking, modx = income,
                               robust = "HC1", cluster = "subclass",
                               johnson_neyman = TRUE, confint = TRUE,
                               data = match.data.j)
```


```{r, echo=FALSE,results='asis'}
kable(nem.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{joint.approach}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the joint approach.") %>%
  kable_styling(latex_options = "hold_position")
```

### Joint approach with exact matching within subgroups  {-}

```{r, warning=FALSE, message=FALSE}
ps.formula.no.mod <- as.formula("smoking ~ age + gender")
match.obj.js <- matchit(ps.formula.no.mod, data = Obs.Data,
                      method = "full", distance = "glm",link = "logit",
                      exact = "income")
match.data.js <- match.data(match.obj.js)
fit.joint.exact <- glm(hypertension ~ smoking*income + age + gender, 
                       data = match.data.js, weights = weights,
                       family = binomial("logit"))
js.nexp.adj.res <- sim_slopes(fit.joint.exact, 
                              pred = smoking, modx = income,
                              robust = "HC1", cluster = "subclass",
                              johnson_neyman = FALSE, confint = TRUE,
                              data = match.data.js)
```


```{r, echo=FALSE,results='asis'}
kable(js.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{joint.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the Joint model, separate matching approach.") %>%
  kable_styling(latex_options = "hold_position")
```

### Interaction approach without exact matching within subgroups {-}

```{r, warning=FALSE, message=FALSE}
ps.formula.with.int <- formula("smoking ~ age*income + gender")
match.obj.i <- matchit(ps.formula.with.int, data = Obs.Data,
                      method = "full", distance = "glm",link = "logit")
match.data.i <- match.data(match.obj.i)
fit.int.no.exact <- glm(hypertension ~ smoking*income + age + gender, 
                        data = match.data.i, weights = weights,
                        family = binomial("logit"))
i.nexp.adj.res <- sim_slopes(fit.int.no.exact, 
                             pred = smoking, modx = income,
                             robust = "HC1", cluster = "subclass",
                             johnson_neyman = FALSE, confint = TRUE,
                             data = match.data.i)
```


```{r, echo=FALSE,results='asis'}
kable(i.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{int.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the interaction approach.") %>%
  kable_styling(latex_options = "hold_position")
```

### Interaction approach with exact matching within subgroups  {-}

```{r, warning=FALSE, message=FALSE}
match.obj.is <- matchit(ps.formula.with.int, data = Obs.Data,
                      method = "full", distance = "glm",link = "logit",
                      exact = "income")
match.data.is <- match.data(match.obj.is)
fit.int.exact <- glm(hypertension ~ smoking*income + age + gender, 
                     data = match.data.is, weights = weights,
                     family = binomial("logit"))
is.nexp.adj.res <- sim_slopes(fit.int.exact, 
                              pred = smoking, modx = income,
                              robust = "HC1", cluster = "subclass",
                              johnson_neyman = FALSE, confint = TRUE,
                              data = match.data.is)
```


```{r, echo=FALSE,results='asis'}
kable(is.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{ints.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the interaction model, separate matching approach.") %>%
  kable_styling(latex_options = "hold_position")
```

## Propensity Score Weighting Approaches

### Common model {-}

```{r, warning=FALSE, message=FALSE}
require(WeightIt)
W.out <- weightit(ps.formula.with.int, data = Obs.Data,
                  method = "ps", estimand = "ATT")
require(survey)
d.w <- svydesign(~1, weights = W.out$weights, data = Obs.Data)
fit2w <- svyglm(hypertension ~ smoking*income, design = d.w,
                family = binomial("logit"))
w.nexp.adj.res <- sim_slopes(fit2w, pred = smoking, modx = income, 
                             confint = TRUE)
```

```{r, echo=FALSE,results='asis'}
kable(w.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{w.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the weighting approach.") %>%
  kable_styling(latex_options = "hold_position")
```

```{r, warning=FALSE, message=FALSE}
W.out.st <- weightit(ps.formula.with.int, data = Obs.Data,
                  method = "ps", estimand = "ATT", stabilize = TRUE)
d.sw <- svydesign(~1, weights = W.out.st$weights, data = Obs.Data)
fit2sw <- svyglm(hypertension ~ smoking*income + age + gender, 
                  design = d.sw,
                  family = binomial("logit"))
ws.nexp.adj.res <- sim_slopes(fit2sw, 
                              pred = smoking, modx = income, 
                              confint = TRUE)
```

```{r, echo=FALSE,results='asis'}
kable(ws.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{ws.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the weighting approach (stabilized).") %>%
  kable_styling(latex_options = "hold_position")
```

### Separate models {-}


```{r, warning=FALSE, message=FALSE}
ps.formula.with.no.int <- formula("smoking ~ age + gender")
W.out1 <- weightit(ps.formula.with.no.int, 
                   data = subset(Obs.Data, income == 1),
                  method = "ps", estimand = "ATT")
trimmed.weight.1.percent1 <- trim(W.out1$weights, 
                                  at = 1, lower = TRUE)
```


```{r, echo=FALSE,results='asis'}
Weight <- c("Raw weights", "1% truncated weights")
show.weight <- cbind(Weight, 
      as.data.frame(rbind(summary(W.out1$weights), 
                          summary(trimmed.weight.1.percent1))))
kable(show.weight,
      booktabs = TRUE, digits = 2,
      caption="\\label{w.summ}Weight summaries before and after truncation.") %>%
  kable_styling(latex_options = "hold_position")
```

```{r,warning=FALSE, message=FALSE}
# Outcome model for income = 1
d.w1 <- svydesign(~1, weights = trimmed.weight.1.percent1, 
                  data = subset(Obs.Data, income == 1))
fit2unadj1 <- svyglm(hypertension ~ smoking, design = d.w1,
                     family = binomial("logit"))
# weight model for income = 0
W.out0 <- weightit(ps.formula, data = subset(Obs.Data, income == 0),
                  method = "ps", estimand = "ATT")
trimmed.weight.1.percent0 <- trim(W.out0$weights, at = 1, lower = TRUE)
# Outcome model for income = 0
d.w0 <- svydesign(~1, weights = trimmed.weight.1.percent0, 
                  data = subset(Obs.Data, income == 0))
fit2unadj0 <- svyglm(hypertension ~ smoking, design = d.w0,
                     family = binomial("logit"))
```

```{r, echo=FALSE,results='asis'}
fit.exp.adj.res1 <- summ(fit2unadj1,  
     model.info = FALSE, 
     model.fit = FALSE, 
     confint = TRUE)
fit.exp.adj.res0 <- summ(fit2unadj0, 
     model.info = FALSE, 
     model.fit = FALSE, 
     confint = TRUE)
kable(cbind(`Value of income` = c(0,1),
            rbind(fit.exp.adj.res0$coeftable[2,],
                  fit.exp.adj.res1$coeftable[2,])),
      booktabs = TRUE, digits = 2,
      caption="\\label{sub.w}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the propensity score weighting approach (Separate weight models).")
```

### Weights from the subgroup balancing propensity scores  {-}


```{r,  warning=FALSE, message=FALSE}
w.out <- weightit(smoking ~ age + gender + income, 
                data = Obs.Data,
                method = "ps", estimand = "ATT")
w.out.sb <- sbps(w.out, moderator = "income")
d.w.sb <- svydesign(~1, weights = w.out.sb$weights, data = Obs.Data)
fit2unadj.sb <- svyglm(hypertension ~ smoking*income, design = d.w.sb,
                       family = binomial("logit"))
sb.w.nexp.adj.res <- sim_slopes(fit2unadj.sb, 
                              pred = smoking, 
                              modx = income, 
                              confint = TRUE,
                              johnson_neyman = FALSE,)
```

```{r, echo=FALSE,results='asis'}
kable(sb.w.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{sb.w.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using the subgroup balancing weighting approach.") %>%
  kable_styling(latex_options = "hold_position")
```


## Propensity Score as a Covariate Adjustment Approaches

### As continuous covariate {-}


```{r,  warning=FALSE, message=FALSE}
# Separate models for each subgroup
# For subgroup income = 1
Obs.Data$ps[Obs.Data$income == 1] <- glm(ps.formula, 
                  data = subset(Obs.Data, income == 1), 
                       family = "binomial")$fitted.values
fit2adj1 <- glm(hypertension ~ smoking + age + gender, family = binomial("logit"), 
               data = subset(Obs.Data, income == 1))
# For subgroup income = 0
Obs.Data$ps[Obs.Data$income == 0] <- glm(ps.formula, 
                  data = subset(Obs.Data, income == 0), 
                       family = "binomial")$fitted.values
fit2adj0 <- glm(hypertension ~ smoking + age + gender, family = binomial("logit"), 
               data = subset(Obs.Data, income == 0))
```

```{r, echo=FALSE,results='asis', warning=FALSE, message=FALSE}
fit.nexp.adj.res1 <- summ(fit2adj1,  
                          robust = TRUE,
                          model.info = FALSE, 
                          model.fit = FALSE, 
                          confint = TRUE)
fit.nexp.adj.res0 <- summ(fit2adj0, 
                          robust = TRUE,
                          model.info = FALSE, 
                          model.fit = FALSE, 
                          confint = TRUE)
kable(cbind(`Value of income` = c(0,1),
            rbind(fit.nexp.adj.res0$coeftable[2,],
                  fit.nexp.adj.res1$coeftable[2,])),
      booktabs = TRUE, digits = 2,
      caption="\\label{covariate.approach}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using Propensity Score as a covariate adjustment approach (considering separate models for each subgroup).") %>%
  kable_styling(latex_options = "hold_position")
```



```{r, include=TRUE}
# Common model
Obs.Data$ps <- glm(ps.formula.with.int, data = Obs.Data,
                       family = "binomial")$fitted.values
fit2adjc <- glm(hypertension ~ smoking*income + age + gender + ps, 
                family = binomial("logit"), 
                data = Obs.Data)
c.nexp.adj.res <- sim_slopes(fit2adjc,
                             pred = smoking, modx = income,
                             confint = TRUE,
                             data = Obs.Data)
```

```{r, echo=FALSE,results='asis', warning=FALSE, message=FALSE}
kable(c.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{c.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using Propensity Score as a covariate adjustment approach (considering a common model).") %>%
  kable_styling(latex_options = "hold_position")
```

### As quantiles {-}

```{r}
Obs.Data$ps <- glm(ps.formula.with.int, 
                  data = Obs.Data, 
                  family = "binomial")$fitted.values
quintiles <- quantile(Obs.Data$ps, 
                      prob = seq(from = 0,to = 1, by = 0.2), 
                      na.rm = T)
Obs.Data$psq <- cut(Obs.Data$ps, breaks = quintiles, 
                   labels = 1:5, include.lowest = T)
Obs.Data$psq <- as.factor(Obs.Data$psq)
fit2adjq <- glm(hypertension ~ (smoking*psq)*income, family = binomial("logit"),
                data = Obs.Data)
cq.nexp.adj.res <- sim_slopes(fit2adjq, 
                              pred = smoking, modx = income, 
                              confint = TRUE,
                              data = Obs.Data)
```

```{r, echo=FALSE,results='asis'}
kable(cq.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{cq.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using Propensity Score as a covariate adjustment approach (as quintiles).") %>%
  kable_styling(latex_options = "hold_position")
```



## Propensity Score Stratification Approaches

```{r, warning=FALSE, message=FALSE}
match.obj <- matchit(ps.formula, data = Obs.Data,
                      method = "subclass", subclass = 3, 
                      estimand = "ATT", min.n = 10)
data.subclass <- match.data(match.obj)
subclass.fit <- glm(hypertension ~ smoking*income, family = binomial("logit"),
              data= data.subclass,
              weights = weights)
subclass.nexp.adj.res <- sim_slopes(subclass.fit, 
                                    pred = smoking, 
                                    modx = income, 
                                    confint = TRUE,
                                    robust = "HC3",
                                    johnson_neyman = FALSE,
                                    data = data.subclass)
```


```{r, echo=FALSE,results='asis'}
kable(subclass.nexp.adj.res$slopes,
      booktabs = TRUE, digits = 2,
      caption="\\label{subgroup.approach.sep}Subgroup-specific treatment effect estimates (expressed in log-OR) from the hypothetical example using propensity score stratification approach.") %>%
  kable_styling(latex_options = "hold_position")
```

# Presenting Results following the Reporting Guideline


```{r, echo=FALSE,results='asis',warning=FALSE, message=FALSE}
require(jtools)
require(interactionR)
kable(summ(fit2sw, exp = TRUE)$coeftable,
      booktabs = TRUE, digits = 2,
      caption="\\label{sw.exp}Subgroup-specific treatment effect estimates (expressed in OR scale) from the hypothetical example using the weighting approach (stabilized).") %>%
  kable_styling(latex_options = "hold_position")
```

```{r, warning=FALSE, message=FALSE}
em.covar  <- interactionR(fit2sw,
                          exposure_names = c("income", "smoking"),
                          ci.type = "mover", ci.level = 0.95,
                          em=TRUE, recode = FALSE)
```

```{r, echo=FALSE,results='asis'}
kable(em.covar$dframe,
      booktabs = TRUE, digits = 2,
      caption="\\label{sw}Reporting recommended estimates from an effect modification analysis from the hypothetical example.") %>%
 add_footnote(c("Propensity score model included the following variables: age and gender, and an interaction term between age and income (moderator).", "Outcome analysis adjusted for the following confounders: age and gender", "Outcome analysis was conducted using the stabilized weights.")) %>% 
  kable_styling(latex_options = "hold_position")
```


