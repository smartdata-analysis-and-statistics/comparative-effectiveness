<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Comparative Effectiveness and Personalized Medicine Research Using Real-World Data - 3&nbsp; Confounding adjustment using propensity score methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter_07.html" rel="next">
<link href="./chapter_03.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter_06.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Confounding adjustment using propensity score methods</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Comparative Effectiveness and Personalized Medicine Research Using Real-World Data</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Validity control and quality assessment of real-world data and real-world evidence</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_06.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Confounding adjustment using propensity score methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Effect Modification Analysis within the Propensity score Framework</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Dealing with missing data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Systematic review and meta-analysis of Real-World Evidence</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Dealing with irregular and informative visits</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Prediction of individual treatment effect using data from multiple studies</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a></li>
  <li><a href="#comparing-baseline-characteristics" id="toc-comparing-baseline-characteristics" class="nav-link" data-scroll-target="#comparing-baseline-characteristics"><span class="header-section-number">3.2</span> Comparing baseline characteristics</a></li>
  <li><a href="#estimating-the-propensity-score" id="toc-estimating-the-propensity-score" class="nav-link" data-scroll-target="#estimating-the-propensity-score"><span class="header-section-number">3.3</span> Estimating the propensity score</a>
  <ul class="collapse">
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression"><span class="header-section-number">3.3.1</span> Logistic regression</a></li>
  <li><a href="#assessing-overlap" id="toc-assessing-overlap" class="nav-link" data-scroll-target="#assessing-overlap"><span class="header-section-number">3.3.2</span> Assessing overlap</a></li>
  </ul></li>
  <li><a href="#propensity-score-matching" id="toc-propensity-score-matching" class="nav-link" data-scroll-target="#propensity-score-matching"><span class="header-section-number">3.4</span> Propensity score matching</a>
  <ul class="collapse">
  <li><a href="#optimal-full-matching-without-replacement" id="toc-optimal-full-matching-without-replacement" class="nav-link" data-scroll-target="#optimal-full-matching-without-replacement"><span class="header-section-number">3.4.1</span> 1:1 Optimal full matching without replacement</a></li>
  <li><a href="#assess-balance-after-matching" id="toc-assess-balance-after-matching" class="nav-link" data-scroll-target="#assess-balance-after-matching"><span class="header-section-number">3.4.2</span> Assess balance after matching</a></li>
  <li><a href="#estimating-the-att" id="toc-estimating-the-att" class="nav-link" data-scroll-target="#estimating-the-att"><span class="header-section-number">3.4.3</span> Estimating the ATT</a></li>
  </ul></li>
  <li><a href="#propensity-score-stratification" id="toc-propensity-score-stratification" class="nav-link" data-scroll-target="#propensity-score-stratification"><span class="header-section-number">3.5</span> Propensity score stratification</a>
  <ul class="collapse">
  <li><a href="#divide-sample-into-quintiles-of-propensity-scores" id="toc-divide-sample-into-quintiles-of-propensity-scores" class="nav-link" data-scroll-target="#divide-sample-into-quintiles-of-propensity-scores"><span class="header-section-number">3.5.1</span> Divide sample into quintiles of propensity scores</a></li>
  <li><a href="#assess-balance-within-each-propensity-score-stratum" id="toc-assess-balance-within-each-propensity-score-stratum" class="nav-link" data-scroll-target="#assess-balance-within-each-propensity-score-stratum"><span class="header-section-number">3.5.2</span> Assess balance within each propensity score stratum</a></li>
  <li><a href="#estimating-and-pooling-of-stratum-specific-treatment-effects" id="toc-estimating-and-pooling-of-stratum-specific-treatment-effects" class="nav-link" data-scroll-target="#estimating-and-pooling-of-stratum-specific-treatment-effects"><span class="header-section-number">3.5.3</span> Estimating and pooling of stratum-specific treatment effects</a></li>
  </ul></li>
  <li><a href="#propensity-score-weighting" id="toc-propensity-score-weighting" class="nav-link" data-scroll-target="#propensity-score-weighting"><span class="header-section-number">3.6</span> Propensity score weighting</a>
  <ul class="collapse">
  <li><a href="#calculate-propensity-score-weights-for-att" id="toc-calculate-propensity-score-weights-for-att" class="nav-link" data-scroll-target="#calculate-propensity-score-weights-for-att"><span class="header-section-number">3.6.1</span> Calculate propensity score weights for ATT</a></li>
  <li><a href="#assess-balance-in-the-weighted-sample" id="toc-assess-balance-in-the-weighted-sample" class="nav-link" data-scroll-target="#assess-balance-in-the-weighted-sample"><span class="header-section-number">3.6.2</span> Assess balance in the weighted sample</a></li>
  <li><a href="#estimate-the-att" id="toc-estimate-the-att" class="nav-link" data-scroll-target="#estimate-the-att"><span class="header-section-number">3.6.3</span> Estimate the ATT</a></li>
  </ul></li>
  <li><a href="#regression-adjustment-for-the-propensity-score-for-the-ate" id="toc-regression-adjustment-for-the-propensity-score-for-the-ate" class="nav-link" data-scroll-target="#regression-adjustment-for-the-propensity-score-for-the-ate"><span class="header-section-number">3.7</span> Regression adjustment for the propensity score for the ATE</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">3.8</span> Overview</a></li>
  <li><a href="#version-info" id="toc-version-info" class="nav-link" data-scroll-target="#version-info">Version info</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Confounding adjustment using propensity score methods</span></h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Tammy Jiang </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Biogen
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    <p class="author">Thomas Debray <a href="https://orcid.org/0000-0002-1790-2719" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Smart Data Analysis and Statistics B.V.
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="introduction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.1</span> Introduction</h2>
<p>The purpose of this document is to provide example R code that demonstrates how to estimate the propensity score and implement matching, stratification, weighting, and regression adjustment for the continuous propensity score. In this example using simulated data, we have two disease modifying therapies (DMT1 and DMT0) and the outcome is the number of post-treatment multiple sclerosis relapses during follow-up. We will estimate the average treatment effect in the treated (ATT) using propensity score matching, stratification, and weighting. We will estimate the average treatment effect in the population (ATE) using regression adjustment for the continuous propensity score. The treatment effects can be interpreted as annualized relapse rate ratios (ARR).</p>
<p>We consider an example dataset with the following characteristics:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-4_66c145f524c89a60d5c20c0bc445540a">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   age female prevDMTefficacy premedicalcost numSymptoms prerelapse_num
1:  50      1            None        3899.61           1              1
2:  51      0            None        9580.51           1              0
3:  56      0            None        4785.89           1              0
4:  44      1            None        8696.80           1              1
5:  63      0            None        2588.03           1              0
6:  28      1            None        5435.57           1              0
   treatment y      years      Iscore
1:      DMT1 0 1.78507871 Moderate A1
2:      DMT1 0 0.01368925     High A1
3:      DMT1 2 3.25530459     High A1
4:      DMT1 2 5.73853525     Neutral
5:      DMT1 0 1.31143053     High A1
6:      DMT1 0 0.59137577 Moderate A0</code></pre>
</div>
</div>
</section>
<section id="comparing-baseline-characteristics" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="comparing-baseline-characteristics"><span class="header-section-number">3.2</span> Comparing baseline characteristics</h2>
<ul>
<li><code>DMT1</code> is the treatment group and <code>DMT0</code> is the control group</li>
<li><code>prevDMTefficacy</code> is previous DMT efficacy (none, low efficacy, and medium/high efficacy)</li>
<li><code>prerelapse_num</code> is the number of previous MS relapses</li>
</ul>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-6_b9f8c7e34e0c0970fa256b0fefa24030">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">2300</td>
<td style="text-align: left;">7700</td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">51.39 (8.32)</td>
<td style="text-align: left;">44.25 (9.79)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">1671 (72.65)</td>
<td style="text-align: left;">5915 (76.82)</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">1247 (54.22)</td>
<td style="text-align: left;">3171 (41.18)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">261 (11.35)</td>
<td style="text-align: left;">858 (11.14)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">792 (34.43)</td>
<td style="text-align: left;">3671 (47.68)</td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.39 (0.62)</td>
<td style="text-align: left;">0.46 (0.68)</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="estimating-the-propensity-score" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="estimating-the-propensity-score"><span class="header-section-number">3.3</span> Estimating the propensity score</h2>
<section id="logistic-regression" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="logistic-regression"><span class="header-section-number">3.3.1</span> Logistic regression</h3>
<p>We sought to restore balance in the distribution of baseline covariates in patients treated with DMT1 (index treatment) and DMT0 (control tratment). We fit a multivariable logistic regression model in which treatment was regressed on baseline characteristics including age, sex, previous DMT efficacy, and previous number of relapses.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-7_6f5de1088820dcedc64e6be6782d195b">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit logistic regression model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ps.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> female <span class="sc">+</span> prevDMTefficacy <span class="sc">+</span> prerelapse_num, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dat, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of logistic regression model</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps.model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = treatment ~ age + female + prevDMTefficacy + prerelapse_num, 
    family = binomial(), data = dat)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7949   0.2585   0.5220   0.7478   1.5033  

Coefficients:
                                     Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                          4.809473   0.157127  30.609  &lt; 2e-16 ***
age                                 -0.086708   0.002996 -28.939  &lt; 2e-16 ***
female1                              0.253611   0.057664   4.398 1.09e-05 ***
prevDMTefficacyLow_efficacy          0.310394   0.083022   3.739 0.000185 ***
prevDMTefficacyMedium_high_efficacy  0.660266   0.054393  12.139  &lt; 2e-16 ***
prerelapse_num                       0.156318   0.039288   3.979 6.93e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 10786  on 9999  degrees of freedom
Residual deviance:  9597  on 9994  degrees of freedom
AIC: 9609

Number of Fisher Scoring iterations: 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract propensity scores</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps.model, <span class="at">data =</span> dat, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assessing-overlap" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="assessing-overlap"><span class="header-section-number">3.3.2</span> Assessing overlap</h3>
<p>We examined the degree of overlap in the distribution of propensity scores across treatment groups using histograms and side-by-side box plots.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-8_c391ba4a92a440841f56f0a16a909058">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> ps, <span class="at">fill =</span> <span class="fu">as.factor</span>(treatment), <span class="at">color =</span> <span class="fu">as.factor</span>(treatment))) <span class="sc">+</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">position=</span><span class="st">'identity'</span>, <span class="at">bins =</span> <span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="fu">as.factor</span>(treatment) <span class="sc">~</span> .) <span class="sc">+</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Probability of Treatment"</span>) <span class="sc">+</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Propensity Score Distribution by Treatment Group"</span>) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.direction =</span> <span class="st">"vertical"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Side-by-side box plots</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(treatment), <span class="at">y=</span>ps, <span class="at">fill=</span><span class="fu">as.factor</span>(treatment))) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Propensity Score Distribution by Treatment Group"</span>) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability of Treatment"</span>) <span class="sc">+</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Treatment group"</span>) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of propensity scores by treatment groups</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>ps[dat<span class="sc">$</span>treatment <span class="sc">==</span> <span class="st">"DMT1"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3230  0.7214  0.8265  0.7970  0.9010  0.9854 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>ps[dat<span class="sc">$</span>treatment <span class="sc">==</span> <span class="st">"DMT0"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3230  0.5730  0.6894  0.6795  0.7975  0.9799 </code></pre>
</div>
</div>
</section>
</section>
<section id="propensity-score-matching" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="propensity-score-matching"><span class="header-section-number">3.4</span> Propensity score matching</h2>
<section id="optimal-full-matching-without-replacement" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="optimal-full-matching-without-replacement"><span class="header-section-number">3.4.1</span> 1:1 Optimal full matching without replacement</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-10_4fe2789053864066ff48e2a89de0d8ab">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use MatchIt package for PS matching</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> female <span class="sc">+</span> prevDMTefficacy <span class="sc">+</span> prerelapse_num, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> dat, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"full"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">estimand =</span> <span class="st">"ATT"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>opt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: Optimal full matching
 - distance: Propensity score
             - estimated with logistic regression
 - number of obs.: 10000 (original), 10000 (matched)
 - target estimand: ATT
 - covariates: age, female, prevDMTefficacy, prerelapse_num</code></pre>
</div>
</div>
</section>
<section id="assess-balance-after-matching" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="assess-balance-after-matching"><span class="header-section-number">3.4.2</span> Assess balance after matching</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-11_dc0acf38e2baad833b793b7cc0f1dd04">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(opt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treatment ~ age + female + prevDMTefficacy + 
    prerelapse_num, data = dat, method = "full", estimand = "ATT")

Summary of Balance for All Data:
                                    Means Treated Means Control Std. Mean Diff.
distance                                   0.7970        0.6795          0.8943
age                                       44.2496       51.3883         -0.7289
female0                                    0.2318        0.2735         -0.0987
female1                                    0.7682        0.7265          0.0987
prevDMTefficacyNone                        0.4118        0.5422         -0.2649
prevDMTefficacyLow_efficacy                0.1114        0.1135         -0.0065
prevDMTefficacyMedium_high_efficacy        0.4768        0.3443          0.2651
prerelapse_num                             0.4595        0.3930          0.0976
                                    Var. Ratio eCDF Mean eCDF Max
distance                                0.7873    0.1917   0.3379
age                                     1.3868    0.1519   0.3085
female0                                      .    0.0417   0.0417
female1                                      .    0.0417   0.0417
prevDMTefficacyNone                          .    0.1304   0.1304
prevDMTefficacyLow_efficacy                  .    0.0020   0.0020
prevDMTefficacyMedium_high_efficacy          .    0.1324   0.1324
prerelapse_num                          1.1990    0.0133   0.0383

Summary of Balance for Matched Data:
                                    Means Treated Means Control Std. Mean Diff.
distance                                   0.7970        0.7970          0.0001
age                                       44.2496       44.1364          0.0116
female0                                    0.2318        0.2517         -0.0470
female1                                    0.7682        0.7483          0.0470
prevDMTefficacyNone                        0.4118        0.4157         -0.0079
prevDMTefficacyLow_efficacy                0.1114        0.1224         -0.0347
prevDMTefficacyMedium_high_efficacy        0.4768        0.4619          0.0297
prerelapse_num                             0.4595        0.4654         -0.0087
                                    Var. Ratio eCDF Mean eCDF Max
distance                                0.9955    0.0012   0.0116
age                                     1.0161    0.0076   0.0260
female0                                      .    0.0199   0.0199
female1                                      .    0.0199   0.0199
prevDMTefficacyNone                          .    0.0039   0.0039
prevDMTefficacyLow_efficacy                  .    0.0109   0.0109
prevDMTefficacyMedium_high_efficacy          .    0.0148   0.0148
prerelapse_num                          0.9530    0.0057   0.0110
                                    Std. Pair Dist.
distance                                     0.0022
age                                          0.1688
female0                                      0.5149
female1                                      0.5149
prevDMTefficacyNone                          0.1816
prevDMTefficacyLow_efficacy                  0.5944
prevDMTefficacyMedium_high_efficacy          0.4731
prerelapse_num                               0.3893

Sample Sizes:
              Control Treated
All           2300.      7700
Matched (ESS)  198.89    7700
Matched       2300.      7700
Unmatched        0.         0
Discarded        0.         0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(opt))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># black line is treated group, grey line is control group</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(opt, <span class="at">type =</span> <span class="st">"density"</span>, <span class="at">which.xs =</span> vars) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-11-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="estimating-the-att" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="estimating-the-att"><span class="header-section-number">3.4.3</span> Estimating the ATT</h3>
<p>We can estimate the ATT in the matched sample using Poisson regression in which the number of post-treatment relapses is regressed on treatment status and follow-up time for each patient (captured by the variable <code>years</code>). More details are provided at .</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-12_27474829a0e2eba96374e3ccca665fce">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Matched data</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>matched.data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(opt)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Poisson regression model</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>opt.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> treatment <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(years)), </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> matched.data, </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">weights =</span> weights)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment effect estimation</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>opt.comp <span class="ot">&lt;-</span> <span class="fu">comparisons</span>(opt.fit,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">variables =</span> <span class="st">"treatment"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">vcov =</span> <span class="sc">~</span>subclass,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata =</span> <span class="fu">subset</span>(matched.data, treatment <span class="sc">==</span> <span class="st">"DMT1"</span>),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">wts =</span> <span class="st">"weights"</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">transform_pre =</span> <span class="st">"ratio"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>opt.comp <span class="sc">|&gt;</span> <span class="fu">tidy</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 9
  type     term      contrast   estim…¹ std.e…² stati…³  p.value conf.…⁴ conf.…⁵
  &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 response treatment mean(DMT1…   0.761   0.100    7.59 3.21e-14   0.564   0.958
# … with abbreviated variable names ¹​estimate, ²​std.error, ³​statistic,
#   ⁴​conf.low, ⁵​conf.high</code></pre>
</div>
</div>
<p>As indicated in the summary output above, the annualized relapse rate ratio for DMT1 vs DMT0 among patients treated with DMT0 (ATT) is given as 0.76 with a 95% confidence interval ranging from 0.56 to 0.96.</p>
</section>
</section>
<section id="propensity-score-stratification" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="propensity-score-stratification"><span class="header-section-number">3.5</span> Propensity score stratification</h2>
<section id="divide-sample-into-quintiles-of-propensity-scores" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="divide-sample-into-quintiles-of-propensity-scores"><span class="header-section-number">3.5.1</span> Divide sample into quintiles of propensity scores</h3>
<p>We will form five mutually exclusive groups of the estimated propensity score.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-14_124c904ac6307b730f4f7fc4051b6a67">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create five strata</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ps.strata =</span> <span class="fu">cut</span>(ps, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">quantile</span>(ps, <span class="at">probs=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.2</span>))),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">include.lowest =</span> <span class="cn">TRUE</span>))</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of patients in each stratum</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dat<span class="sc">$</span>ps.strata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2    3    4    5 
2002 2015 1991 1997 1995 </code></pre>
</div>
</div>
</section>
<section id="assess-balance-within-each-propensity-score-stratum" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="assess-balance-within-each-propensity-score-stratum"><span class="header-section-number">3.5.2</span> Assess balance within each propensity score stratum</h3>
<p>Within each propensity score stratum, treated and control patients should have similar values of the propensity score and the distribution of baseline covariates should be approximately balanced between treatment groups.</p>
<section id="propensity-score-stratum-1" class="level4" data-number="3.5.2.1">
<h4 data-number="3.5.2.1" class="anchored" data-anchor-id="propensity-score-stratum-1"><span class="header-section-number">3.5.2.1</span> Propensity Score Stratum #1</h4>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-15_19bf74c02aa4731c4f40963e13097269">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tab1.strata1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>tab1.strata1.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata1, <span class="at">catDigits =</span> <span class="dv">2</span>, <span class="at">contDigits =</span> <span class="dv">2</span>, </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">smd =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-16_de4337e9da10d530011cf898861d0c5f">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">901</td>
<td style="text-align: left;">1101</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">58.38 (3.67)</td>
<td style="text-align: left;">57.45 (3.73)</td>
<td style="text-align: left;">0.251</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">605 (67.15)</td>
<td style="text-align: left;">775 (70.39)</td>
<td style="text-align: left;">0.070</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.056</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">650 (72.14)</td>
<td style="text-align: left;">771 (70.03)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">106 (11.76)</td>
<td style="text-align: left;">130 (11.81)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">145 (16.09)</td>
<td style="text-align: left;">200 (18.17)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.29 (0.53)</td>
<td style="text-align: left;">0.33 (0.56)</td>
<td style="text-align: left;">0.074</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-2" class="level4" data-number="3.5.2.2">
<h4 data-number="3.5.2.2" class="anchored" data-anchor-id="propensity-score-stratum-2"><span class="header-section-number">3.5.2.2</span> Propensity Score Stratum #2</h4>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-17_71708a0b318e304731ffc6581d16ddda">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>tab1.strata2 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> <span class="dv">2</span>), </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>tab1.strata2.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata2, <span class="at">catDigits =</span> <span class="dv">2</span>, <span class="at">contDigits =</span> <span class="dv">2</span>, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">smd =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-18_51802becffb1e8aeff64c319f2071b31">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">617</td>
<td style="text-align: left;">1398</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">52.18 (4.35)</td>
<td style="text-align: left;">51.97 (4.22)</td>
<td style="text-align: left;">0.049</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">458 (74.23)</td>
<td style="text-align: left;">1048 (74.96)</td>
<td style="text-align: left;">0.017</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.054</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">292 (47.33)</td>
<td style="text-align: left;">624 (44.64)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">69 (11.18)</td>
<td style="text-align: left;">162 (11.59)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">256 (41.49)</td>
<td style="text-align: left;">612 (43.78)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.40 (0.64)</td>
<td style="text-align: left;">0.41 (0.66)</td>
<td style="text-align: left;">0.004</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-3" class="level4" data-number="3.5.2.3">
<h4 data-number="3.5.2.3" class="anchored" data-anchor-id="propensity-score-stratum-3"><span class="header-section-number">3.5.2.3</span> Propensity Score Stratum #3</h4>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-19_5921c68fd67cda426cc9f8ff60c87f86">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tab1.strata3 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> <span class="dv">3</span>), </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>tab1.strata3.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata3, <span class="at">catDigits =</span> <span class="dv">2</span>, <span class="at">contDigits =</span> <span class="dv">2</span>, </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">smd =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-20_dbf1976e871f3800b991f9f2fe5c2376">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">392</td>
<td style="text-align: left;">1599</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">46.73 (4.06)</td>
<td style="text-align: left;">46.36 (4.08)</td>
<td style="text-align: left;">0.092</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">305 (77.81)</td>
<td style="text-align: left;">1193 (74.61)</td>
<td style="text-align: left;">0.075</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.041</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">168 (42.86)</td>
<td style="text-align: left;">687 (42.96)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">52 (13.27)</td>
<td style="text-align: left;">191 (11.94)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">172 (43.88)</td>
<td style="text-align: left;">721 (45.09)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.49 (0.68)</td>
<td style="text-align: left;">0.47 (0.66)</td>
<td style="text-align: left;">0.031</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-4" class="level4" data-number="3.5.2.4">
<h4 data-number="3.5.2.4" class="anchored" data-anchor-id="propensity-score-stratum-4"><span class="header-section-number">3.5.2.4</span> Propensity Score Stratum #4</h4>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-21_87dbcdcae80308415bc50dd076fac9b1">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>tab1.strata4 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> <span class="dv">4</span>), </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>tab1.strata4.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata4, <span class="at">catDigits =</span> <span class="dv">2</span>, <span class="at">contDigits =</span> <span class="dv">2</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">smd =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-22_b25d942efbdfeee51f1413197a2b84c6">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">269</td>
<td style="text-align: left;">1728</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">41.07 (4.11)</td>
<td style="text-align: left;">40.88 (4.29)</td>
<td style="text-align: left;">0.046</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">203 (75.46)</td>
<td style="text-align: left;">1356 (78.47)</td>
<td style="text-align: left;">0.071</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.084</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">105 (39.03)</td>
<td style="text-align: left;">634 (36.69)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">22 ( 8.18)</td>
<td style="text-align: left;">181 (10.47)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">142 (52.79)</td>
<td style="text-align: left;">913 (52.84)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.50 (0.69)</td>
<td style="text-align: left;">0.51 (0.71)</td>
<td style="text-align: left;">0.012</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-5" class="level4" data-number="3.5.2.5">
<h4 data-number="3.5.2.5" class="anchored" data-anchor-id="propensity-score-stratum-5"><span class="header-section-number">3.5.2.5</span> Propensity Score Stratum #5</h4>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-23_95520ede42894f32d7c14b87299b5b25">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tab1.strata5 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> <span class="dv">5</span>), </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>tab1.strata5.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata5, <span class="at">catDigits =</span> <span class="dv">2</span>, <span class="at">contDigits =</span> <span class="dv">2</span>, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">smd =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-24_708ce9d63233838cf3b89d577ce5cdf4">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">121</td>
<td style="text-align: left;">1874</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">33.26 (4.95)</td>
<td style="text-align: left;">32.04 (5.58)</td>
<td style="text-align: left;">0.233</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">100 (82.64)</td>
<td style="text-align: left;">1543 (82.34)</td>
<td style="text-align: left;">0.008</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.050</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">32 (26.45)</td>
<td style="text-align: left;">455 (24.28)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">12 ( 9.92)</td>
<td style="text-align: left;">194 (10.35)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">77 (63.64)</td>
<td style="text-align: left;">1225 (65.37)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.52 (0.66)</td>
<td style="text-align: left;">0.52 (0.73)</td>
<td style="text-align: left;">0.004</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="estimating-and-pooling-of-stratum-specific-treatment-effects" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="estimating-and-pooling-of-stratum-specific-treatment-effects"><span class="header-section-number">3.5.3</span> Estimating and pooling of stratum-specific treatment effects</h3>
<p>The overall ATT across strata can be estimated by weighting stratum-specific estimates by the proportion of treated patients in each stratum over all treated patients in the sample.</p>
<p>We first define a function <code>att.strata.function()</code> to calculate stratum-specific estimates of the treatment effect:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-25_3920d031b4333fd1b9dbd7a9c3b2052f">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>att.strata.function <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stratum, <span class="at">confint =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="st">"y ~ treatment + offset(log(years))"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> stratum))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  arr <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="st">"treatmentDMT1"</span>])), <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">&lt;-</span> ul <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (confint) {</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    ll <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(fit))[<span class="st">"treatmentDMT1"</span>,<span class="dv">1</span>], <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    ul <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(fit))[<span class="st">"treatmentDMT1"</span>,<span class="dv">2</span>], <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="st">"stratum"</span> <span class="ot">=</span> stratum,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>           <span class="st">"arr"</span> <span class="ot">=</span> arr,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>           <span class="st">"ci_lower"</span>  <span class="ot">=</span> ll,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>           <span class="st">"ci_upper"</span>  <span class="ot">=</span> ul))</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>arr.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, att.strata.function, <span class="at">data =</span> dat)))</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>arr.strata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  stratum   arr ci_lower ci_upper
1       1 0.904    0.760    1.076
2       2 0.822    0.696    0.975
3       3 0.798    0.666    0.961
4       4 0.716    0.587    0.881
5       5 0.589    0.463    0.761</code></pre>
</div>
</div>
<p>Subsequently, we define a function <code>weights.strata.function()</code> to calculate the weights for each stratum. The weight is the proportion of treated patients in each stratum over all treated patients in the sample:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-26_b58f224bb29eeedfdb303211f2ac4453">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>weights.strata.function <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stratum) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  n_DMT1_stratum <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> stratum <span class="sc">&amp;</span> treatment <span class="sc">==</span> <span class="st">"DMT1"</span>))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  n_DMT1_all <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"DMT1"</span>))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> n_DMT1_stratum<span class="sc">/</span>n_DMT1_all</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="st">"stratum"</span> <span class="ot">=</span> stratum, <span class="st">"weight"</span> <span class="ot">=</span> weight))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>weights.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, weights.strata.function, <span class="at">data =</span> dat)))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>weights.strata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  stratum    weight
1       1 0.1429870
2       2 0.1815584
3       3 0.2076623
4       4 0.2244156
5       5 0.2433766</code></pre>
</div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-27_50c094be6f41b8d69b90e447a244f358">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create table with ARRs and weights for each PS stratum</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>arr.weights.merged <span class="ot">&lt;-</span> <span class="fu">merge</span>(arr.strata, weights.strata, <span class="at">by =</span> <span class="st">"stratum"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the weighted ARR for each stratum</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>arr.weights.merged <span class="ot">&lt;-</span> arr.weights.merged <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weighted.arr =</span> <span class="fu">as.numeric</span>(arr) <span class="sc">*</span> weight)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Sum the weighted ARRs across strata to get the overall ATT</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(arr.weights.merged<span class="sc">$</span>weighted.arr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7482462</code></pre>
</div>
</div>
<p>We now define a new function <code>ps.stratification.bootstrap()</code> that integrates estimation of the ATT and the PS weights for bootstrapping purposes:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-29_539022f56ba4304a47e2d5cca8ff0b06">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ps.stratification.bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(data, inds) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> data[inds,]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  d<span class="sc">$</span>ps.strata <span class="ot">&lt;-</span> <span class="fu">cut</span>(d<span class="sc">$</span>ps, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">quantile</span>(dat<span class="sc">$</span>ps, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>))),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">5</span>),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  arr.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, att.strata.function, </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">data =</span> d, <span class="at">confint =</span> <span class="cn">FALSE</span>)))</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  weights.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, weights.strata.function, <span class="at">data =</span> d)))</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(arr.strata<span class="sc">$</span>arr[<span class="dv">1</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">2</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">2</span>] <span class="sc">+</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">3</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">3</span>] <span class="sc">+</span> </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">4</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">4</span>] <span class="sc">+</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">5</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">5</span>])                                                  </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now estimate the treatment effect and its confidence interval using the bootstrap procedure:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-30_df51c49f4193304a2d9f028d8ffabe94">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'boot'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:survival':

    aml</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1854</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>arr.stratification.boot <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> dat, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">statistic =</span> ps.stratification.bootstrap, </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">R =</span> <span class="dv">1000</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrapped ARR</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(arr.stratification.boot<span class="sc">$</span>t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7558609</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrapped ARR 95% CI</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(arr.stratification.boot<span class="sc">$</span>t[,<span class="dv">1</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     2.5%     97.5% 
0.6835885 0.8362947 </code></pre>
</div>
</div>
</section>
</section>
<section id="propensity-score-weighting" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="propensity-score-weighting"><span class="header-section-number">3.6</span> Propensity score weighting</h2>
<section id="calculate-propensity-score-weights-for-att" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="calculate-propensity-score-weights-for-att"><span class="header-section-number">3.6.1</span> Calculate propensity score weights for ATT</h3>
<p>Propensity score weighting reweights the study sample to generate an artificial population (i.e., pseudo-population) in which the covariates are no longer associated with treatment, thereby removing confounding by measured covariates. For the ATT, the weight for all treated patients is set to one. Conversely, the weight for patients in the control group is set to the propensity score divided by one minus the propensity score, that is, (PS/(1 − PS)). We estimated stabilized weights to address extreme weights.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-32_d682ab515921be3d94a7e2bd7eebf50e">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>w.out <span class="ot">&lt;-</span> <span class="fu">weightit</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> female <span class="sc">+</span> prevDMTefficacy <span class="sc">+</span> prerelapse_num,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> dat,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"ps"</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">estimand =</span> <span class="st">"ATT"</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>                  <span class="co">#stabilize = TRUE)</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>w.out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A weightit object
 - method: "ps" (propensity score weighting)
 - number of obs.: 10000
 - sampling weights: none
 - treatment: 2-category
 - estimand: ATT (focal: DMT1)
 - covariates: age, female, prevDMTefficacy, prerelapse_num</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(w.out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                   Max
DMT0 0.4772 |---------------------------| 48.6856
DMT1 1.0000  ||                            1.0000

- Units with 5 most extreme weights by group:
                                             
         9492    8836    6544    9610    4729
 DMT0 32.1027 32.1027 34.3126 38.1817 48.6856
            6       4       3       2       1
 DMT1       1       1       1       1       1

- Weight statistics:

     Coef of Var   MAD Entropy # Zeros
DMT0       1.098 0.673   0.383       0
DMT1       0.000 0.000  -0.000       0

- Effective Sample Sizes:

              DMT0 DMT1
Unweighted 2300.   7700
Weighted   1043.16 7700</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(w.out))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="assess-balance-in-the-weighted-sample" class="level3" data-number="3.6.2">
<h3 data-number="3.6.2" class="anchored" data-anchor-id="assess-balance-in-the-weighted-sample"><span class="header-section-number">3.6.2</span> Assess balance in the weighted sample</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-33_cf1ef56ed92148cd4ca92d7c304fbe5b">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(w.out, <span class="at">stats =</span> <span class="fu">c</span>(<span class="st">"m"</span>, <span class="st">"v"</span>), <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">05</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
                                         Type Diff.Adj     M.Threshold
prop.score                           Distance  -0.0045 Balanced, &lt;0.05
age                                   Contin.   0.0054 Balanced, &lt;0.05
female                                 Binary   0.0005 Balanced, &lt;0.05
prevDMTefficacy_None                   Binary  -0.0003 Balanced, &lt;0.05
prevDMTefficacy_Low_efficacy           Binary   0.0023 Balanced, &lt;0.05
prevDMTefficacy_Medium_high_efficacy   Binary  -0.0020 Balanced, &lt;0.05
prerelapse_num                        Contin.  -0.0034 Balanced, &lt;0.05
                                     V.Ratio.Adj
prop.score                                0.9926
age                                       1.0102
female                                         .
prevDMTefficacy_None                           .
prevDMTefficacy_Low_efficacy                   .
prevDMTefficacy_Medium_high_efficacy           .
prerelapse_num                            1.0941

Balance tally for mean differences
                    count
Balanced, &lt;0.05         7
Not Balanced, &gt;0.05     0

Variable with the greatest mean difference
 Variable Diff.Adj     M.Threshold
      age   0.0054 Balanced, &lt;0.05

Effective sample sizes
              DMT0 DMT1
Unadjusted 2300.   7700
Adjusted   1043.16 7700</code></pre>
</div>
</div>
</section>
<section id="estimate-the-att" class="level3" data-number="3.6.3">
<h3 data-number="3.6.3" class="anchored" data-anchor-id="estimate-the-att"><span class="header-section-number">3.6.3</span> Estimate the ATT</h3>
<p>One way to estimate the ATT is to use the survey package. The function <code>svyglm()</code> generates model-robust (Horvitz-Thompson-type) standard errors by default, and thus does not require additional adjustments.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-34_3345074188f7fe0a2a5232cc43367ab7">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>weighted.data <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> dat, <span class="at">weights =</span> <span class="sc">~</span>w.out<span class="sc">$</span>weights)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>weighted.fit <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(y <span class="sc">~</span> treatment <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(years)),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">design =</span> weighted.data)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(weighted.fit)[<span class="st">"treatmentDMT1"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>treatmentDMT1 
    0.7083381 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">confint</span>(weighted.fit))[<span class="st">"treatmentDMT1"</span>,] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5 %    97.5 % 
0.6245507 0.8033662 </code></pre>
</div>
</div>
<p>As indicated above, propensity score weighting yielded an ATT estimate of 0.71 (95% CI: 0.66; 0.76).</p>
<p>An alternative approach is to use <code>glm()</code> to estimate the treatment effect and calculate robust standard errors.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-36_0e5948d6d72a9bd55483eac075d4e091">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative way to estimate treatment effect</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>weighted.fit2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> treatment <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(years)),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> dat,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">weights =</span> w.out<span class="sc">$</span>weights)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the estimated ARR</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(weighted.fit2))[<span class="st">"treatmentDMT1"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>treatmentDMT1 
    0.7083381 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate robust standard error and p-value of the log ARR</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(weighted.fit2, <span class="at">vcov. =</span> vcovHC)[<span class="st">"treatmentDMT1"</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate    Std. Error       z value      Pr(&gt;|z|) 
-3.448337e-01  6.442745e-02 -5.352280e+00  8.685284e-08 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Derive 95% confidence interval of the ARR</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(lmtest<span class="sc">::</span><span class="fu">coefci</span>(weighted.fit2, </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">level =</span> <span class="fl">0.95</span>, <span class="co"># 95% confidence interval</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">vcov. =</span> vcovHC)[<span class="st">"treatmentDMT1"</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5 %    97.5 % 
0.6243094 0.8036767 </code></pre>
</div>
</div>
<p>Using this approach, the ATT estimate was 0.71 (95% CI: 0.62; 0.8).</p>
</section>
</section>
<section id="regression-adjustment-for-the-propensity-score-for-the-ate" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="regression-adjustment-for-the-propensity-score-for-the-ate"><span class="header-section-number">3.7</span> Regression adjustment for the propensity score for the ATE</h2>
<p>In this approach, a regression model is fitted to describe the observed outcome as a function of the received treatment and the estimated propensity score:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-38_48f989d5e322325a62232640f17ecaf7">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>ps.reg.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> treatment <span class="sc">+</span> ps <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(years)),</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> dat)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps.reg.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ treatment + ps + offset(log(years)), family = poisson(link = "log"), 
    data = dat)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.0160  -0.7336  -0.4441  -0.1352   4.2634  

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   -1.99585    0.10359 -19.266  &lt; 2e-16 ***
treatmentDMT1 -0.25598    0.04431  -5.777 7.60e-09 ***
ps             1.07521    0.13878   7.748 9.36e-15 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 7514.7  on 9999  degrees of freedom
Residual deviance: 7443.0  on 9997  degrees of freedom
AIC: 12378

Number of Fisher Scoring iterations: 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ATE</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(ps.reg.fit))[<span class="st">"treatmentDMT1"</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>treatmentDMT1 
    0.7741606 </code></pre>
</div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-39_738575ac160aec0ea503d4e903c3df8e">
<div class="cell-output cell-output-stderr">
<pre><code>Waiting for profiling to be done...
Waiting for profiling to be done...</code></pre>
</div>
</div>
<p>Bootstrapped confidence intervals can be obtained as follows:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-40_3f768598ef457cc4ffd440a721e6655b">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to bootstrap for 95% CIs</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>ps.reg.bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(data, inds) {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> data[inds,]</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> treatment <span class="sc">+</span> ps <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(years)),</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> d)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(fit))[<span class="st">"treatmentDMT1"</span>])</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1854</span>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 1000 bootstrap replicates</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>arr.boot <span class="ot">&lt;-</span> <span class="fu">boot</span>(dat, <span class="at">statistic =</span> ps.reg.bootstrap, <span class="at">R =</span> <span class="dv">1000</span>) </span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the median annualized relapse rate across 1000 bootstrap replicates</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(arr.boot<span class="sc">$</span>t) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7750426</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take 2.5th and 97.5th percentiles to be 95% CI</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(arr.boot<span class="sc">$</span>t[,<span class="dv">1</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     2.5%     97.5% 
0.7010540 0.8545169 </code></pre>
</div>
</div>
</section>
<section id="overview" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="overview"><span class="header-section-number">3.8</span> Overview</h2>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-42_fb69e7166c91114cb437adf48339e69d">
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 51%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: left;">Estimand</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">95% CI (lower)</th>
<th style="text-align: right;">95% CI (upper)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Optimal full matching</td>
<td style="text-align: left;">ATT</td>
<td style="text-align: right;">0.8039901</td>
<td style="text-align: right;">0.6040414</td>
<td style="text-align: right;">1.0039388</td>
</tr>
<tr class="even">
<td style="text-align: left;">Propensity score stratification</td>
<td style="text-align: left;">ATT</td>
<td style="text-align: right;">0.7482462</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Propensity score stratification (with bootstrapping)</td>
<td style="text-align: left;">ATT</td>
<td style="text-align: right;">0.7558609</td>
<td style="text-align: right;">0.6835885</td>
<td style="text-align: right;">0.8362947</td>
</tr>
<tr class="even">
<td style="text-align: left;">Propensity score weighting</td>
<td style="text-align: left;">ATT</td>
<td style="text-align: right;">0.7083381</td>
<td style="text-align: right;">0.6245507</td>
<td style="text-align: right;">0.8033662</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Propensity score weighting (robust SE)</td>
<td style="text-align: left;">ATT</td>
<td style="text-align: right;">0.7083381</td>
<td style="text-align: right;">0.6243094</td>
<td style="text-align: right;">0.8036767</td>
</tr>
<tr class="even">
<td style="text-align: left;">PS regression adjustment</td>
<td style="text-align: left;">ATE</td>
<td style="text-align: right;">0.7741606</td>
<td style="text-align: right;">0.7101080</td>
<td style="text-align: right;">0.8448218</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PS regression adjustment (bootstrapping)</td>
<td style="text-align: left;">ATE</td>
<td style="text-align: right;">0.7750426</td>
<td style="text-align: right;">0.7010540</td>
<td style="text-align: right;">0.8545169</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="version-info" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="version-info">Version info</h2>
<p>This chapter was rendered using the following version of R and its packages:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-43_e168d792a855e5086a255b97bcc6dfbd">
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.2.3 (2023-03-15 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19044)

Matrix products: default

locale:
[1] LC_COLLATE=Dutch_Netherlands.utf8  LC_CTYPE=Dutch_Netherlands.utf8   
[3] LC_MONETARY=Dutch_Netherlands.utf8 LC_NUMERIC=C                      
[5] LC_TIME=Dutch_Netherlands.utf8    

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
 [1] MatchIt_4.5.3          sandwich_3.0-2         WeightIt_0.14.1       
 [4] truncnorm_1.0-9        tableone_0.13.2        survey_4.2-1          
 [7] survival_3.5-5         Matrix_1.5-4           MASS_7.3-58.3         
[10] marginaleffects_0.12.0 lmtest_0.9-40          zoo_1.8-12            
[13] knitr_1.42             ggplot2_3.4.2          data.table_1.14.8     
[16] cobalt_4.5.1           boot_1.3-28.1          dplyr_1.1.1           

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.10       pillar_1.9.0      compiler_4.2.3    tools_4.2.3      
 [5] digest_0.6.31     lattice_0.21-8    jsonlite_1.8.4    evaluate_0.21    
 [9] lifecycle_1.0.3   tibble_3.2.1      gtable_0.3.3      pkgconfig_2.0.3  
[13] rlang_1.1.0       DBI_1.1.3         cli_3.6.1         rstudioapi_0.14  
[17] yaml_2.3.7        xfun_0.39         fastmap_1.1.1     withr_2.5.0      
[21] mitools_2.4       generics_0.1.3    vctrs_0.6.1       htmlwidgets_1.6.2
[25] tidyselect_1.2.0  glue_1.6.2        R6_2.5.1          fansi_1.0.4      
[29] rmarkdown_2.21    magrittr_2.0.3    splines_4.2.3     scales_1.2.1     
[33] backports_1.4.1   htmltools_0.5.5   colorspace_2.1-0  utf8_1.2.3       
[37] munsell_0.5.0     crayon_1.5.2     </code></pre>
</div>
</div>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter_03.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Validity control and quality assessment of real-world data and real-world evidence</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter_07.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Effect Modification Analysis within the Propensity score Framework</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>