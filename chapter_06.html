<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tammy Jiang">
<meta name="dcterms.date" content="2023-02-01">

<title>Confounding adjustment using propensity score methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="chapter_06_files/libs/clipboard/clipboard.min.js"></script>
<script src="chapter_06_files/libs/quarto-html/quarto.js"></script>
<script src="chapter_06_files/libs/quarto-html/popper.min.js"></script>
<script src="chapter_06_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="chapter_06_files/libs/quarto-html/anchor.min.js"></script>
<link href="chapter_06_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="chapter_06_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="chapter_06_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="chapter_06_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="chapter_06_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#goal" id="toc-goal" class="nav-link active" data-scroll-target="#goal"><span class="toc-section-number">1</span>  Goal</a></li>
  <li><a href="#comparing-baseline-characteristics" id="toc-comparing-baseline-characteristics" class="nav-link" data-scroll-target="#comparing-baseline-characteristics"><span class="toc-section-number">2</span>  Comparing baseline characteristics</a></li>
  <li><a href="#estimating-the-propensity-score" id="toc-estimating-the-propensity-score" class="nav-link" data-scroll-target="#estimating-the-propensity-score"><span class="toc-section-number">3</span>  Estimating the propensity score</a>
  <ul class="collapse">
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression"><span class="toc-section-number">3.1</span>  Logistic regression</a></li>
  <li><a href="#assessing-overlap" id="toc-assessing-overlap" class="nav-link" data-scroll-target="#assessing-overlap"><span class="toc-section-number">3.2</span>  Assessing overlap</a></li>
  </ul></li>
  <li><a href="#propensity-score-matching" id="toc-propensity-score-matching" class="nav-link" data-scroll-target="#propensity-score-matching"><span class="toc-section-number">4</span>  Propensity score matching</a>
  <ul class="collapse">
  <li><a href="#optimal-full-matching-without-replacement" id="toc-optimal-full-matching-without-replacement" class="nav-link" data-scroll-target="#optimal-full-matching-without-replacement"><span class="toc-section-number">4.1</span>  1:1 Optimal full matching without replacement</a></li>
  <li><a href="#assess-balance-after-matching" id="toc-assess-balance-after-matching" class="nav-link" data-scroll-target="#assess-balance-after-matching"><span class="toc-section-number">4.2</span>  Assess balance after matching</a></li>
  <li><a href="#estimating-the-att" id="toc-estimating-the-att" class="nav-link" data-scroll-target="#estimating-the-att"><span class="toc-section-number">4.3</span>  Estimating the ATT</a></li>
  </ul></li>
  <li><a href="#propensity-score-stratification" id="toc-propensity-score-stratification" class="nav-link" data-scroll-target="#propensity-score-stratification"><span class="toc-section-number">5</span>  Propensity score stratification</a>
  <ul class="collapse">
  <li><a href="#divide-sample-into-quintiles-of-propensity-scores" id="toc-divide-sample-into-quintiles-of-propensity-scores" class="nav-link" data-scroll-target="#divide-sample-into-quintiles-of-propensity-scores"><span class="toc-section-number">5.1</span>  Divide sample into quintiles of propensity scores</a></li>
  <li><a href="#assess-balance-within-each-propensity-score-stratum" id="toc-assess-balance-within-each-propensity-score-stratum" class="nav-link" data-scroll-target="#assess-balance-within-each-propensity-score-stratum"><span class="toc-section-number">5.2</span>  Assess balance within each propensity score stratum</a>
  <ul class="collapse">
  <li><a href="#propensity-score-stratum-1" id="toc-propensity-score-stratum-1" class="nav-link" data-scroll-target="#propensity-score-stratum-1"><span class="toc-section-number">5.2.1</span>  Propensity Score Stratum #1</a></li>
  <li><a href="#propensity-score-stratum-2" id="toc-propensity-score-stratum-2" class="nav-link" data-scroll-target="#propensity-score-stratum-2"><span class="toc-section-number">5.2.2</span>  Propensity Score Stratum #2</a></li>
  <li><a href="#propensity-score-stratum-3" id="toc-propensity-score-stratum-3" class="nav-link" data-scroll-target="#propensity-score-stratum-3"><span class="toc-section-number">5.2.3</span>  Propensity Score Stratum #3</a></li>
  <li><a href="#propensity-score-stratum-4" id="toc-propensity-score-stratum-4" class="nav-link" data-scroll-target="#propensity-score-stratum-4"><span class="toc-section-number">5.2.4</span>  Propensity Score Stratum #4</a></li>
  <li><a href="#propensity-score-stratum-5" id="toc-propensity-score-stratum-5" class="nav-link" data-scroll-target="#propensity-score-stratum-5"><span class="toc-section-number">5.2.5</span>  Propensity Score Stratum #5</a></li>
  </ul></li>
  <li><a href="#estimating-and-pooling-of-stratum-specific-treatment-effects" id="toc-estimating-and-pooling-of-stratum-specific-treatment-effects" class="nav-link" data-scroll-target="#estimating-and-pooling-of-stratum-specific-treatment-effects"><span class="toc-section-number">5.3</span>  Estimating and pooling of stratum-specific treatment effects</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Confounding adjustment using propensity score methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tammy Jiang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 1, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-1_696a9c0b65c32f96013c749689f9ada2">

</div>
<section id="goal" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Goal</h1>
<p>The purpose of this document is to provide example R code that demonstrates how to estimate the propensity score and implement matching, stratification, weighting, and regression adjustment for the continuous propensity score. In this example using simulated data, we have two disease modifying therapies (DMT1 and DMT0) and the outcome is the number of post-treatment multiple sclerosis relapses during follow-up. We will estimate the average treatment effect in the treated (ATT) using propensity score matching, stratification, and weighting. We will estimate the average treatment effect in the population (ATE) using regression adjustment for the continuous propensity score. The treatment effects can be interpreted as annualized relapse rate ratios (ARR).</p>
<p>We consider an example dataset with the following characteristics:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-4_66c145f524c89a60d5c20c0bc445540a">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   age female prevDMTefficacy premedicalcost numSymptoms prerelapse_num
1:  50      1            None        3899.61           1              1
2:  51      0            None        9580.51           1              0
3:  56      0            None        4785.89           1              0
4:  44      1            None        8696.80           1              1
5:  63      0            None        2588.03           1              0
6:  28      1            None        5435.57           1              0
   treatment y      years      Iscore
1:      DMT1 0 1.78507871 Moderate A1
2:      DMT1 0 0.01368925     High A1
3:      DMT1 2 3.25530459     High A1
4:      DMT1 2 5.73853525     Neutral
5:      DMT1 0 1.31143053     High A1
6:      DMT1 0 0.59137577 Moderate A0</code></pre>
</div>
</div>
</section>
<section id="comparing-baseline-characteristics" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Comparing baseline characteristics</h1>
<ul>
<li>DMT1 is the treatment group and DMT0 is the control group</li>
<li><code>prevDMTefficacy</code> is previous DMT efficacy (none, low efficacy, and medium/high efficacy)</li>
<li><code>prerelapse_num</code> is the number of previous MS relapses</li>
</ul>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-6_b9f8c7e34e0c0970fa256b0fefa24030">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">2300</td>
<td style="text-align: left;">7700</td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">51.39 (8.32)</td>
<td style="text-align: left;">44.25 (9.79)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">1671 (72.65)</td>
<td style="text-align: left;">5915 (76.82)</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">1247 (54.22)</td>
<td style="text-align: left;">3171 (41.18)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">261 (11.35)</td>
<td style="text-align: left;">858 (11.14)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">792 (34.43)</td>
<td style="text-align: left;">3671 (47.68)</td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.39 (0.62)</td>
<td style="text-align: left;">0.46 (0.68)</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="estimating-the-propensity-score" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Estimating the propensity score</h1>
<section id="logistic-regression" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="logistic-regression"><span class="header-section-number">3.1</span> Logistic regression</h2>
<p>We sought to restore balance in the distribution of baseline covariates in patients treated with DMT1 (index treatment) and DMT0 (control tratment). We fit a multivariable logistic regression model in which treatment was regressed on baseline characteristics including age, sex, previous DMT efficacy, and previous number of relapses.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-7_6f5de1088820dcedc64e6be6782d195b">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit logistic regression model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ps.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> female <span class="sc">+</span> prevDMTefficacy <span class="sc">+</span> prerelapse_num, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dat, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of logistic regression model</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps.model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = treatment ~ age + female + prevDMTefficacy + prerelapse_num, 
    family = binomial(), data = dat)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.7949   0.2585   0.5220   0.7478   1.5033  

Coefficients:
                                     Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                          4.809473   0.157127  30.609  &lt; 2e-16 ***
age                                 -0.086708   0.002996 -28.939  &lt; 2e-16 ***
female1                              0.253611   0.057664   4.398 1.09e-05 ***
prevDMTefficacyLow_efficacy          0.310394   0.083022   3.739 0.000185 ***
prevDMTefficacyMedium_high_efficacy  0.660266   0.054393  12.139  &lt; 2e-16 ***
prerelapse_num                       0.156318   0.039288   3.979 6.93e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 10786  on 9999  degrees of freedom
Residual deviance:  9597  on 9994  degrees of freedom
AIC: 9609

Number of Fisher Scoring iterations: 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract propensity scores</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps.model, <span class="at">data =</span> dat, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assessing-overlap" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="assessing-overlap"><span class="header-section-number">3.2</span> Assessing overlap</h2>
<p>We examined the degree of overlap in the distribution of propensity scores across treatment groups using histograms and side-by-side box plots.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-8_00364ee751cc009b9b0b6e58ac5465ae">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x=</span>ps, <span class="at">fill=</span><span class="fu">as.factor</span>(treatment), <span class="at">color=</span><span class="fu">as.factor</span>(treatment))) <span class="sc">+</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">alpha=</span><span class="fl">0.3</span>, <span class="at">position=</span><span class="st">'identity'</span>, <span class="at">bins=</span><span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="fu">as.factor</span>(treatment) <span class="sc">~</span> .) <span class="sc">+</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Probability of Treatment"</span>) <span class="sc">+</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Propensity Score Distribution by Treatment Group"</span>) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.direction =</span> <span class="st">"vertical"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Side-by-side box plots</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(treatment), <span class="at">y=</span>ps, <span class="at">fill=</span><span class="fu">as.factor</span>(treatment))) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Propensity Score Distribution by Treatment Group"</span>) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability of Treatment"</span>) <span class="sc">+</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Treatment group"</span>) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of propensity scores by treatment groups</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>ps[dat<span class="sc">$</span>treatment<span class="sc">==</span><span class="st">"DMT1"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3230  0.7214  0.8265  0.7970  0.9010  0.9854 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>ps[dat<span class="sc">$</span>treatment<span class="sc">==</span><span class="st">"DMT0"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3230  0.5730  0.6894  0.6795  0.7975  0.9799 </code></pre>
</div>
</div>
</section>
</section>
<section id="propensity-score-matching" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Propensity score matching</h1>
<section id="optimal-full-matching-without-replacement" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="optimal-full-matching-without-replacement"><span class="header-section-number">4.1</span> 1:1 Optimal full matching without replacement</h2>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-9_7215dbcad2987319d8984d478301ee9a">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use MatchIt package for PS matching</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treatment <span class="sc">~</span> age <span class="sc">+</span> female <span class="sc">+</span> prevDMTefficacy <span class="sc">+</span> prerelapse_num, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> dat, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"full"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">estimand =</span> <span class="st">"ATT"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>opt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: Optimal full matching
 - distance: Propensity score
             - estimated with logistic regression
 - number of obs.: 10000 (original), 10000 (matched)
 - target estimand: ATT
 - covariates: age, female, prevDMTefficacy, prerelapse_num</code></pre>
</div>
</div>
</section>
<section id="assess-balance-after-matching" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="assess-balance-after-matching"><span class="header-section-number">4.2</span> Assess balance after matching</h2>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-10_da60f8b6dd084a573747ed227a87ec27">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(opt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treatment ~ age + female + prevDMTefficacy + 
    prerelapse_num, data = dat, method = "full", estimand = "ATT")

Summary of Balance for All Data:
                                    Means Treated Means Control Std. Mean Diff.
distance                                   0.7970        0.6795          0.8943
age                                       44.2496       51.3883         -0.7289
female0                                    0.2318        0.2735         -0.0987
female1                                    0.7682        0.7265          0.0987
prevDMTefficacyNone                        0.4118        0.5422         -0.2649
prevDMTefficacyLow_efficacy                0.1114        0.1135         -0.0065
prevDMTefficacyMedium_high_efficacy        0.4768        0.3443          0.2651
prerelapse_num                             0.4595        0.3930          0.0976
                                    Var. Ratio eCDF Mean eCDF Max
distance                                0.7873    0.1917   0.3379
age                                     1.3868    0.1519   0.3085
female0                                      .    0.0417   0.0417
female1                                      .    0.0417   0.0417
prevDMTefficacyNone                          .    0.1304   0.1304
prevDMTefficacyLow_efficacy                  .    0.0020   0.0020
prevDMTefficacyMedium_high_efficacy          .    0.1324   0.1324
prerelapse_num                          1.1990    0.0133   0.0383

Summary of Balance for Matched Data:
                                    Means Treated Means Control Std. Mean Diff.
distance                                   0.7970        0.7970          0.0001
age                                       44.2496       44.1364          0.0116
female0                                    0.2318        0.2517         -0.0470
female1                                    0.7682        0.7483          0.0470
prevDMTefficacyNone                        0.4118        0.4157         -0.0079
prevDMTefficacyLow_efficacy                0.1114        0.1224         -0.0347
prevDMTefficacyMedium_high_efficacy        0.4768        0.4619          0.0297
prerelapse_num                             0.4595        0.4654         -0.0087
                                    Var. Ratio eCDF Mean eCDF Max
distance                                0.9955    0.0012   0.0116
age                                     1.0161    0.0076   0.0260
female0                                      .    0.0199   0.0199
female1                                      .    0.0199   0.0199
prevDMTefficacyNone                          .    0.0039   0.0039
prevDMTefficacyLow_efficacy                  .    0.0109   0.0109
prevDMTefficacyMedium_high_efficacy          .    0.0148   0.0148
prerelapse_num                          0.9530    0.0057   0.0110
                                    Std. Pair Dist.
distance                                     0.0022
age                                          0.1688
female0                                      0.5149
female1                                      0.5149
prevDMTefficacyNone                          0.1816
prevDMTefficacyLow_efficacy                  0.5944
prevDMTefficacyMedium_high_efficacy          0.4731
prerelapse_num                               0.3893

Sample Sizes:
              Control Treated
All           2300.      7700
Matched (ESS)  198.89    7700
Matched       2300.      7700
Unmatched        0.         0
Discarded        0.         0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">summary</span>(opt))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># black line is treated group, grey line is control group</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(opt, <span class="at">type =</span> <span class="st">"density"</span>, <span class="at">which.xs =</span> vars) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="chapter_06_files/figure-html/unnamed-chunk-10-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="estimating-the-att" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="estimating-the-att"><span class="header-section-number">4.3</span> Estimating the ATT</h2>
<p>We can estimate the ATT in the matched sample using Poisson regression in which the number of post-treatment relapses is regressed on treatment status and follow-up time for each patient (captured by the variable <code>years</code>). More details are provided at .</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-11_8e661a6ce4c3b36b3a7526933c390473">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Matched data</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>matched.data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(opt)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Poisson regression model</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>opt.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> treatment <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(years)), </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> matched.data, </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">weights =</span> weights)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment effect estimation</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>opt.comp <span class="ot">&lt;-</span> <span class="fu">comparisons</span>(opt.fit,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">variables =</span> <span class="st">"treatment"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">vcov =</span> <span class="sc">~</span>subclass,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata =</span> <span class="fu">subset</span>(matched.data, treatment <span class="sc">==</span> <span class="st">"DMT1"</span>),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">wts =</span> <span class="st">"weights"</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">transform_pre =</span> <span class="st">"ratio"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>opt.comp <span class="sc">|&gt;</span> <span class="fu">tidy</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 9
  type     term      contrast   estim…¹ std.e…² stati…³  p.value conf.…⁴ conf.…⁵
  &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 response treatment mean(DMT1…   0.761   0.100    7.59 3.21e-14   0.564   0.958
# … with abbreviated variable names ¹​estimate, ²​std.error, ³​statistic,
#   ⁴​conf.low, ⁵​conf.high</code></pre>
</div>
</div>
<p>As indicated in the summary output above, the annualized relapse rate ratio for DMT1 vs DMT0 among patients treated with DMT0 (ATT) is given as 0.76 with a 95% confidence interval ranging from 0.56 to 0.96.</p>
</section>
</section>
<section id="propensity-score-stratification" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Propensity score stratification</h1>
<section id="divide-sample-into-quintiles-of-propensity-scores" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="divide-sample-into-quintiles-of-propensity-scores"><span class="header-section-number">5.1</span> Divide sample into quintiles of propensity scores</h2>
<p>We will form five mutually exclusive groups of the estimated propensity score.</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-13_bf35b8148f8c9951402f1692d5c0023b">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create five strata</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ps.strata =</span> <span class="fu">cut</span>(ps, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">breaks=</span><span class="fu">c</span>(<span class="fu">quantile</span>(ps, <span class="at">probs=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.2</span>))),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">labels=</span><span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">include.lowest =</span> <span class="cn">TRUE</span>))</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of patients in each stratum</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dat<span class="sc">$</span>ps.strata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2    3    4    5 
2002 2015 1991 1997 1995 </code></pre>
</div>
</div>
</section>
<section id="assess-balance-within-each-propensity-score-stratum" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="assess-balance-within-each-propensity-score-stratum"><span class="header-section-number">5.2</span> Assess balance within each propensity score stratum</h2>
<p>Within each propensity score stratum, treated and control patients should have similar values of the propensity score and the distribution of baseline covariates should be approximately balanced between treatment groups.</p>
<section id="propensity-score-stratum-1" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="propensity-score-stratum-1"><span class="header-section-number">5.2.1</span> Propensity Score Stratum #1</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-14_ed52046ab85d63f40a6afc67518b4261">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tab1.strata1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata<span class="sc">==</span><span class="dv">1</span>), </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>tab1.strata1.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata1, <span class="at">catDigits=</span><span class="dv">2</span>, <span class="at">contDigits=</span><span class="dv">2</span>, <span class="at">smd=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-15_60b4f7e10029e0e107ae8e485dbdc4ac">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">901</td>
<td style="text-align: left;">1101</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">58.38 (3.67)</td>
<td style="text-align: left;">57.45 (3.73)</td>
<td style="text-align: left;">0.251</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">605 (67.15)</td>
<td style="text-align: left;">775 (70.39)</td>
<td style="text-align: left;">0.070</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.056</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">650 (72.14)</td>
<td style="text-align: left;">771 (70.03)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">106 (11.76)</td>
<td style="text-align: left;">130 (11.81)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">145 (16.09)</td>
<td style="text-align: left;">200 (18.17)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.29 (0.53)</td>
<td style="text-align: left;">0.33 (0.56)</td>
<td style="text-align: left;">0.074</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-2" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="propensity-score-stratum-2"><span class="header-section-number">5.2.2</span> Propensity Score Stratum #2</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-16_809de1b2d8d450f8e877c142eb0e444d">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>tab1.strata2 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata<span class="sc">==</span><span class="dv">2</span>), </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>tab1.strata2.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata2, <span class="at">catDigits=</span><span class="dv">2</span>, <span class="at">contDigits=</span><span class="dv">2</span>, <span class="at">smd=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-17_f539101e0db415e339974244a2748b3d">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">617</td>
<td style="text-align: left;">1398</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">52.18 (4.35)</td>
<td style="text-align: left;">51.97 (4.22)</td>
<td style="text-align: left;">0.049</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">458 (74.23)</td>
<td style="text-align: left;">1048 (74.96)</td>
<td style="text-align: left;">0.017</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.054</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">292 (47.33)</td>
<td style="text-align: left;">624 (44.64)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">69 (11.18)</td>
<td style="text-align: left;">162 (11.59)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">256 (41.49)</td>
<td style="text-align: left;">612 (43.78)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.40 (0.64)</td>
<td style="text-align: left;">0.41 (0.66)</td>
<td style="text-align: left;">0.004</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-3" class="level3" data-number="5.2.3">
<h3 data-number="5.2.3" class="anchored" data-anchor-id="propensity-score-stratum-3"><span class="header-section-number">5.2.3</span> Propensity Score Stratum #3</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-18_946f9b62cb182d59c94861ac66536fda">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tab1.strata3 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata<span class="sc">==</span><span class="dv">3</span>), </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>tab1.strata3.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata3, <span class="at">catDigits=</span><span class="dv">2</span>, <span class="at">contDigits=</span><span class="dv">2</span>, <span class="at">smd=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-19_9859fab5fd80d741e6f2f8a487c49903">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">392</td>
<td style="text-align: left;">1599</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">46.73 (4.06)</td>
<td style="text-align: left;">46.36 (4.08)</td>
<td style="text-align: left;">0.092</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">305 (77.81)</td>
<td style="text-align: left;">1193 (74.61)</td>
<td style="text-align: left;">0.075</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.041</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">168 (42.86)</td>
<td style="text-align: left;">687 (42.96)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">52 (13.27)</td>
<td style="text-align: left;">191 (11.94)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">172 (43.88)</td>
<td style="text-align: left;">721 (45.09)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.49 (0.68)</td>
<td style="text-align: left;">0.47 (0.66)</td>
<td style="text-align: left;">0.031</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-4" class="level3" data-number="5.2.4">
<h3 data-number="5.2.4" class="anchored" data-anchor-id="propensity-score-stratum-4"><span class="header-section-number">5.2.4</span> Propensity Score Stratum #4</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-20_e46c6dffd1d851a97eaf853445d5e8a6">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>tab1.strata4 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata<span class="sc">==</span><span class="dv">4</span>), </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>tab1.strata4.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata4, <span class="at">catDigits=</span><span class="dv">2</span>, <span class="at">contDigits=</span><span class="dv">2</span>, <span class="at">smd=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-21_64017541e698fbfebd176ddcbffe05d5">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">269</td>
<td style="text-align: left;">1728</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">41.07 (4.11)</td>
<td style="text-align: left;">40.88 (4.29)</td>
<td style="text-align: left;">0.046</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">203 (75.46)</td>
<td style="text-align: left;">1356 (78.47)</td>
<td style="text-align: left;">0.071</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.084</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">105 (39.03)</td>
<td style="text-align: left;">634 (36.69)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">22 ( 8.18)</td>
<td style="text-align: left;">181 (10.47)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">142 (52.79)</td>
<td style="text-align: left;">913 (52.84)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.50 (0.69)</td>
<td style="text-align: left;">0.51 (0.71)</td>
<td style="text-align: left;">0.012</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="propensity-score-stratum-5" class="level3" data-number="5.2.5">
<h3 data-number="5.2.5" class="anchored" data-anchor-id="propensity-score-stratum-5"><span class="header-section-number">5.2.5</span> Propensity Score Stratum #5</h3>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-22_db25c127e9065468553d1afa3d01ff9c">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tab1.strata5 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(vars, <span class="at">data =</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata<span class="sc">==</span><span class="dv">5</span>), </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">factorVars =</span> <span class="fu">c</span>(<span class="st">"female"</span>, <span class="st">"prevDMTefficacy"</span>), </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="st">"treatment"</span>, <span class="at">test =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>tab1.strata5.print <span class="ot">&lt;-</span> <span class="fu">print</span>(tab1.strata5, <span class="at">catDigits=</span><span class="dv">2</span>, <span class="at">contDigits=</span><span class="dv">2</span>, <span class="at">smd=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-23_551a9eeacef79dabd6ce813411ce7d5a">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">DMT0</th>
<th style="text-align: left;">DMT1</th>
<th style="text-align: left;">SMD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">n</td>
<td style="text-align: left;">121</td>
<td style="text-align: left;">1874</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">age (mean (SD))</td>
<td style="text-align: left;">33.26 (4.95)</td>
<td style="text-align: left;">32.04 (5.58)</td>
<td style="text-align: left;">0.233</td>
</tr>
<tr class="odd">
<td style="text-align: left;">female = 1 (%)</td>
<td style="text-align: left;">100 (82.64)</td>
<td style="text-align: left;">1543 (82.34)</td>
<td style="text-align: left;">0.008</td>
</tr>
<tr class="even">
<td style="text-align: left;">prevDMTefficacy (%)</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0.050</td>
</tr>
<tr class="odd">
<td style="text-align: left;">None</td>
<td style="text-align: left;">32 (26.45)</td>
<td style="text-align: left;">455 (24.28)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Low_efficacy</td>
<td style="text-align: left;">12 ( 9.92)</td>
<td style="text-align: left;">194 (10.35)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Medium_high_efficacy</td>
<td style="text-align: left;">77 (63.64)</td>
<td style="text-align: left;">1225 (65.37)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">prerelapse_num (mean (SD))</td>
<td style="text-align: left;">0.52 (0.66)</td>
<td style="text-align: left;">0.52 (0.73)</td>
<td style="text-align: left;">0.004</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="estimating-and-pooling-of-stratum-specific-treatment-effects" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="estimating-and-pooling-of-stratum-specific-treatment-effects"><span class="header-section-number">5.3</span> Estimating and pooling of stratum-specific treatment effects</h2>
<p>The overall ATT across strata can be estimated by weighting stratum-specific estimates by the proportion of treated patients in each stratum over all treated patients in the sample.</p>
<p>We first define a function <code>att.strata.function()</code> to calculate stratum-specific estimates of the treatment effect:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-24_b6386b449bfd8f94045f8e35bc006a68">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>att.strata.function <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stratum, <span class="at">confint =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="st">"y ~ treatment + offset(log(years))"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link=</span><span class="st">"log"</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> stratum))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  arr <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="st">"treatmentDMT1"</span>])), <span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">&lt;-</span> ul <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (confint) {</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    ll <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(fit))[<span class="st">"treatmentDMT1"</span>,<span class="dv">1</span>], <span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    ul <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(fit))[<span class="st">"treatmentDMT1"</span>,<span class="dv">2</span>], <span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="st">"stratum"</span> <span class="ot">=</span> stratum,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>           <span class="st">"arr"</span> <span class="ot">=</span> arr,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>           <span class="st">"ci_lower"</span>  <span class="ot">=</span> ll,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>           <span class="st">"ci_upper"</span>  <span class="ot">=</span> ul))</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>arr.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, att.strata.function, <span class="at">data =</span> dat)))</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>arr.strata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  stratum   arr ci_lower ci_upper
1       1 0.904    0.760    1.076
2       2 0.822    0.696    0.975
3       3 0.798    0.666    0.961
4       4 0.716    0.587    0.881
5       5 0.589    0.463    0.761</code></pre>
</div>
</div>
<p>Subsequently, we define a function <code>weights.strata.function()</code> to calculate the weights for each stratum. The weight is the proportion of treated patients in each stratum over all treated patients in the sample:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-25_3de47ecafd76698d0ff660ae7a111fe9">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>weights.strata.function <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stratum) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  n_DMT1_stratum <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ps.strata <span class="sc">==</span> stratum <span class="sc">&amp;</span> treatment <span class="sc">==</span> <span class="st">"DMT1"</span>))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  n_DMT1_all <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"DMT1"</span>))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  weight <span class="ot">&lt;-</span> n_DMT1_stratum<span class="sc">/</span>n_DMT1_all</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="st">"stratum"</span> <span class="ot">=</span> stratum, <span class="st">"weight"</span> <span class="ot">=</span> weight))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>weights.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, weights.strata.function, <span class="at">data =</span> dat)))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>weights.strata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  stratum    weight
1       1 0.1429870
2       2 0.1815584
3       3 0.2076623
4       4 0.2244156
5       5 0.2433766</code></pre>
</div>
</div>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-26_7d988fc1dbc67c1af577b71ba28178c2">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create table with ARRs and weights for each PS stratum</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>arr.weights.merged <span class="ot">&lt;-</span> <span class="fu">merge</span>(arr.strata, weights.strata, <span class="at">by=</span><span class="st">"stratum"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the weighted ARR for each stratum</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>arr.weights.merged <span class="ot">&lt;-</span> arr.weights.merged <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weighted.arr =</span> <span class="fu">as.numeric</span>(arr) <span class="sc">*</span> weight)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Sum the weighted ARRs across strata to get the overall ATT</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(arr.weights.merged<span class="sc">$</span>weighted.arr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7482462</code></pre>
</div>
</div>
<p>We now define a new function <code>ps.stratification.bootstrap()</code> that integrates estimation of the ATT and the PS weights for bootstrapping purposes:</p>
<div class="cell" data-hash="chapter_06_cache/html/unnamed-chunk-27_17b2bfc71f88c324fffee7cf9c7f649b">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ps.stratification.bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(data, stratum) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> data[stratum,]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  d<span class="sc">$</span>ps.strata <span class="ot">&lt;-</span> <span class="fu">cut</span>(d<span class="sc">$</span>ps, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">breaks=</span><span class="fu">c</span>(<span class="fu">quantile</span>(dat<span class="sc">$</span>ps, <span class="at">probs=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.2</span>))),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels=</span><span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">include.lowest=</span>T)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  arr.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, att.strata.function, </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">data =</span> d, <span class="at">confint =</span> <span class="cn">FALSE</span>)))</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  weights.strata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, weights.strata.function, <span class="at">data =</span> d)))</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(arr.strata<span class="sc">$</span>arr[<span class="dv">1</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">2</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">2</span>] <span class="sc">+</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">3</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">3</span>] <span class="sc">+</span> </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">4</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">4</span>] <span class="sc">+</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>           arr.strata<span class="sc">$</span>arr[<span class="dv">5</span>] <span class="sc">*</span> weights.strata<span class="sc">$</span>weight[<span class="dv">5</span>])                                                  </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1854</span>)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>arr.stratification.boot <span class="ot">&lt;-</span> <span class="fu">boot</span>(dat, ps.stratification.bootstrap, <span class="at">R=</span><span class="dv">1000</span>) <span class="co"># 1000 bootstrap replicates</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrapped ARR</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(arr.stratification.boot<span class="sc">$</span>t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7558609</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrapped ARR 95% CI</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(arr.stratification.boot<span class="sc">$</span>t[,<span class="dv">1</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     2.5%     97.5% 
0.6835885 0.8362947 </code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>